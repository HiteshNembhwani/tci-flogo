"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var expr_parser_1=require("../models/mapper/expr-parser"),utils_1=require("../util/utils"),constants_1=require("../constants"),lodash=require("lodash"),constants_2=require("../constants"),schema=require("generate-schema"),contributionHelper_1=require("../util/contributionHelper"),CUIApp=function(){function e(){}return e.isJson=function(e){try{e=JSON.parse(e)}catch(a){e={}}return!e.type||!e.properties&&!e.items},e.triggerFlowToJSON=function(e){var a,t,s=this;if(lodash.forOwn(e.items,function(e,a){return e.taskType!==constants_1.TASK_TYPE.TASK_ROOT||(t=lodash.cloneDeep(e),!1)}),t){var r={},i=[],n={};if(t.settings&&t.settings.forEach(function(e){n[e.name]="string"==typeof e.value?e.value.trim():e.value}),t.handler&&t.settings){r.actionId=lodash.get(e,"name",""),r.description=lodash.get(e,"description","Operation description");var l={};t.handler.settings.forEach(function(e){if(e.value&&void 0!==e.value)if("complex_object"===e.type){if(e.value&&e.value.value)if(l[e.name]={metadata:"",value:e.value.value},s.isJson(e.value.value))try{l[e.name].metadata=JSON.stringify(schema.json(JSON.parse(e.value.value)))}catch(e){}else try{l[e.name].metadata=e.value.value}catch(e){}}else l[e.name]="string"==typeof e.value?e.value.trim():e.value}),r.settings=l;var o={};t.outputs.forEach(function(e){if(e.value&&void 0!==e.value)if("complex_object"===e.type){if(e.value&&e.value.value)if(o[e.name]={metadata:"",value:e.value.value},e.display&&"texteditor"===e.display.type)if(s.isJson(e.value.value))try{o[e.name].metadata=JSON.stringify(schema.json(JSON.parse(e.value.value)))}catch(e){}else try{o[e.name].metadata=e.value.value}catch(e){}else if(e.display&&"params"===e.display.type)try{var a=JSON.parse(e.value.value);o[e.name].metadata=contributionHelper_1.ContributionHelper.jsonToSchema(a)}catch(e){}}else o[e.name]="string"==typeof e.value?e.value.trim():e.value}),r.outputs=o}lodash.isEmpty(r)?i=null:i.push(r),t.ref=t.ref.replace("https://","").replace("http://","");var u=t.ref;a={id:t.id,ref:u,settings:n,handlers:i}}return a},e.flogoFlowToJSON=function(e){function a(e,a,s,r,i){t(e,[],a,s,r,i)}function t(e,a,n,l,u,p){if(!lodash.includes(a,e.id)){a.push(e.id);var c=lodash.difference(e.children,a);lodash.each(c,function(c){var d=n[c];if(d.type!==constants_2.FLOW_DIAGRAM_NODE_TYPE.NODE_ADD&&d.type!==constants_2.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT_NEW)if(d.type!==constants_2.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH){var f=l[d.taskID];if(s(f)){var h={};h.id=utils_1.convertTaskID(f.id),h.name=lodash.get(f,"title",""),h.type=f.taskType,h.activityType=f.activityType,f.ref=f.ref.replace("https://","").replace("http://",""),h.activityRef=f.ref;var m=lodash.get(f,"inputs");h.attributes=i(m,f),h.attributes=lodash.filter(h.attributes,function(e){return!(lodash.isNil(e.value)||lodash.isObject(e.value)&&lodash.isEmpty(e.value))});var y={};f.outputs.forEach(function(e){if(e.value&&void 0!==e.value)if("complex_object"===e.type){if(e.value&&e.value.value)if(y[e.name]={metadata:"",value:e.value.value},e.display&&"texteditor"===e.display.type)if(r(e.value.value))try{y[e.name].metadata=JSON.stringify(schema.json(JSON.parse(e.value.value)))}catch(e){}else try{y[e.name].metadata=e.value.value}catch(e){}else if(e.display&&"params"===e.display.type)try{var a=JSON.parse(e.value.value);y[e.name].metadata=contributionHelper_1.ContributionHelper.jsonToSchema(a)}catch(e){}}else y[e.name]="string"==typeof e.value?e.value.trim():e.value}),h.outputs=y;var g=o(lodash.get(f,"inputMappings"));lodash.isEmpty(g)||(h.inputMappings=g),u.push(h)}if(e.type===constants_2.FLOW_DIAGRAM_NODE_TYPE.NODE)p.push({id:v(),from:utils_1.convertTaskID(e.taskID),to:utils_1.convertTaskID(d.taskID),type:constants_2.FLOW_DIAGRAM_FLOW_LINK_TYPE.DEFAULT});else if(e.type===constants_2.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH&&1===e.parents.length){var _=n[e.parents[0]],O=l[e.taskID];if(_.type!==constants_2.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT){var T={id:v(),from:utils_1.convertTaskID(_.taskID),to:utils_1.convertTaskID(d.taskID),type:constants_2.FLOW_DIAGRAM_FLOW_LINK_TYPE.BRANCH,value:O.inputMappings.mappings&&O.inputMappings.mappings.condition.expression?O.inputMappings.mappings.condition.expression:""};p.push(T)}}t(d,a,n,l,u,p)}else(O=l[d.taskID])&&1===d.children.length&&t(d,a,n,l,u,p)})}}function s(e){return(!lodash.isEmpty(e)||!u)&&((!lodash.isEmpty(e.id)||!u)&&(!(!lodash.isNumber(e.taskType)&&u)&&(!lodash.isEmpty(e.activityType)||!u)))}function r(e){try{e=JSON.parse(e)}catch(a){e={}}return!e.type||!e.properties&&!e.items}function i(e,a){var t=[];return lodash.each(e,function(e){var a={};if(a.name=lodash.get(e,"name"),a.type=lodash.get(e,"type"),"complex_object"===lodash.get(e,"type")&&e.value&&e.value.value){if(a.value={metadata:"",value:e.value.value},"texteditor"===e.display.type){if(e.value.value)if(r(e.value.value))try{a.value.metadata=JSON.stringify(schema.json(JSON.parse(e.value.value)))}catch(e){}else try{a.value.metadata=e.value.value}catch(e){}}else if("Params"===e.display.type&&e.value.value)try{var s=JSON.parse(e.value.value);a.value.metadata=contributionHelper_1.ContributionHelper.jsonToSchema(s)}catch(e){}}else a.value=lodash.get(e,"value",constants_1.getDefaultValue(e.type)),a.value="string"==typeof a.value?a.value.trim():a.value;lodash.isEmpty(a.name)&&u||(e.display&&"fileselector"===e.display.type&&a.value&&a.value.content&&(a.value=a.value.content),t.push(a))}),t}function n(e){var a=e.indexOf("array.forEach")+14,t=e.indexOf(")"),s=e.substring(a,t).trim();return s||"NEWARRAY"}function l(e,a){var t={};if(t.to=e,a[e].expression.indexOf("array.forEach")>-1){t.from=n(a[e].expression.replace(/[\r\n]/g,"")),t.type="foreach",t.fields=[];for(var s in a[e].mappings)t.fields.push(l(s,a[e].mappings))}else'"'===a[e].expression.charAt(0)||"'"===a[e].expression.charAt(0)?t.from=a[e].expression.substring(1,a[e].expression.length-1):t.from=a[e].expression.replace(/[\r\n]/g,""),t.type="primitive";return t}function o(e){var a=[];for(var t in e.mappings){var s={};s.mapTo=t,e.mappings[t].expression.indexOf("array.forEach")>-1?(s.type=4,s.value=JSON.stringify(l(t,e.mappings))):(s.type=3,'"'===e.mappings[t].expression.charAt(0)||"'"===e.mappings[t].expression.charAt(0)?s.value=e.mappings[t].expression.substring(1,e.mappings[t].expression.length-1):s.value=e.mappings[t].expression.replace(/[\r\n]/g,"")),a.push(s)}return a}var u=!1,p=0,v=function(){return++p},c={},d=lodash.get(e,"_id");if(lodash.isEmpty(d)&&u)return c;var f=lodash.get(e,"paths"),h=lodash.get(f,"root"),m=lodash.get(f,"nodes");if(lodash.isEmpty(f)||lodash.isEmpty(h)||lodash.isEmpty(m)&&u)return c;var y=lodash.get(e,"items");return lodash.isEmpty(y)&&u?c:(c.id=lodash.get(e,"name",""),c.ref="github.com/TIBCOSoftware/flogo-contrib/action/flow",c.data={flow:{}},c.data.flow=function(){var t={};t.name=lodash.get(e,"name",""),t.model=lodash.get(e,"model","tibco-simple"),t.ref="github.com/TIBCOSoftware/flogo-contrib/model/simple",t.type=lodash.get(e,"type",constants_1.PROCESS_TYPE.DEFAULT),t.attributes=[],t.rootTask=function(){var e={id:1,type:constants_1.TASK_TYPE.TASK,activityType:"",name:"root",tasks:[],links:[]};return a(m[h.is],m,y,e.tasks,e.links),e}();var s=lodash.get(e,"errorHandler"),r={},i={};for(var n in s)if(s.hasOwnProperty(n)){var l=s[n];r=lodash.get(l,"items"),i=lodash.get(l,"paths")}return lodash.isEmpty(r)||Object.keys(r).length<=1?t:(t.errorHandlerTask=function(){var e=lodash.get(i,"root"),t=lodash.get(i,"nodes"),s=t[e.is],n={id:utils_1.convertTaskID(s.taskID),type:constants_1.TASK_TYPE.TASK,activityType:"",name:"error_root",tasks:[],links:[]};return a(s,t,r,n.tasks,n.links),n}(),t)}(),function(e){e=lodash.toArray(e);for(var a=0;a<e.length;a++)if(e[a]&&"tibco-wi-rest"===e[a].name&&e[a].taskType===constants_1.TASK_TYPE.TASK_ROOT)return!0;return!1}(y)&&(c.data.flow.explicitReply=!0),c)},e.uiModelToRtModel=function(e){function a(e){try{e=JSON.parse(e)}catch(a){e={}}return!e.type||!e.properties&&!e.items}function t(e,t){var s={};if(t&&t.handler&&t.settings){s.actionId=lodash.get(e,"name",""),s.description=lodash.get(e,"description","Operation description");var r={};t.handler.settings.forEach(function(e){if(e.value&&void 0!==e.value)if("complex_object"===e.type){if(e.value&&e.value.value)if(r[e.name]={metadata:"",value:e.value.value},a(e.value.value))try{r[e.name].metadata=JSON.stringify(schema.json(JSON.parse(e.value.value)))}catch(e){}else try{r[e.name].metadata=e.value.value}catch(e){}}else r[e.name]="string"==typeof e.value?e.value.trim():e.value}),s.settings=r;var i={};t.outputs.forEach(function(e){if(e.value&&void 0!==e.value)if("complex_object"===e.type){if(e.value&&e.value.value)if(i[e.name]={metadata:"",value:e.value.value},e.display&&"texteditor"===e.display.type)if(a(e.value.value))try{i[e.name].metadata=JSON.stringify(schema.json(JSON.parse(e.value.value)))}catch(e){}else try{i[e.name].metadata=e.value.value}catch(e){}else if(e.display&&"params"===e.display.type)try{var t=JSON.parse(e.value.value);i[e.name].metadata=contributionHelper_1.ContributionHelper.jsonToSchema(t)}catch(e){}}else i[e.name]="string"==typeof e.value?e.value.trim():e.value}),s.outputs=i}return s}var s={};s.name=lodash.get(e,"applicationName",""),s.description=lodash.get(e,"description",""),s.version=""+lodash.get(e,"version","0.0.1"),s.type=""+lodash.get(e,"type","wi");var r=e.flows,i=!0;s.actions=[];var n=this;for(var l in r)!function(e){if(r.hasOwnProperty(e)){var a=r[e];if(s.actions.push(n.flogoFlowToJSON(a)),i)s.triggers=[],s.triggers.push(n.triggerFlowToJSON(a)),i=!1;else{var l;if(lodash.forOwn(a.items,function(e,a){return e.taskType!==constants_1.TASK_TYPE.TASK_ROOT||(l=lodash.cloneDeep(e),!1)}),l){l.ref=l.ref.replace("https://","").replace("http://","");for(var o=l.ref,u=!1,p=0;p<s.triggers.length;p++)if(s.triggers[p].ref===o){s.triggers[p].handlers.push(t(a,l)),u=!0;break}u||s.triggers.push(n.triggerFlowToJSON(a))}}}}(l);return s},e}();exports.CUIApp=CUIApp;