"use strict";var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])};return function(e,o){function r(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(r.prototype=o.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var lodash=require("lodash"),BaseNode=function(){function t(t,e){this.name=t,this.location=e}return t.prototype.getName=function(){return this.name},t.prototype.getLocation=function(){return this.location},t.prototype.setName=function(t){this.name=t},t}();exports.BaseNode=BaseNode;var BaseExpressionNode=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(BaseNode);exports.BaseExpressionNode=BaseExpressionNode;var ProgramNode=function(t){function e(e){var o=t.call(this,"Program",null)||this;return o.body=e,o}return __extends(e,t),e.prototype.getBody=function(){return this.body},e.prototype.accept=function(t){if(t.visitEnterProgram(this),this.body&&Array.isArray(this.body))for(var e=0,o=this.body;e<o.length;e++){var r=o[e],n=NodeFactory.createNode(r);n&&n.accept(t)}t.visitLeaveProgram(this)},e}(BaseNode);exports.ProgramNode=ProgramNode;var ExpressionStatementNode=function(t){function e(e){var o=t.call(this,"ExpressionStatement",null)||this;return o.expression=e,o}return __extends(e,t),e.prototype.getExpression=function(){return this.expression},e.prototype.accept=function(t){t.visitEnterExpressionStatement(this),this.expression&&NodeFactory.createNode(this.expression).accept(t),t.visitLeaveExpressionStatement(this)},e}(BaseNode);exports.ExpressionStatementNode=ExpressionStatementNode;var ArgumentNode=function(){function t(t){this.node=t}return t.prototype.accept=function(t){t.visitEnterArgument(this),this.node.accept(t),t.visitLeaveArgument(this)},t}();exports.ArgumentNode=ArgumentNode;var CallExpressionNode=function(t){function e(e,o){var r=t.call(this,"CallExpression",null)||this;return r.callee=e,r.args=o,r}return __extends(e,t),e.prototype.getCallee=function(){return this.callee},e.prototype.getArguments=function(){return this.args},e.prototype.getExpression=function(){return this.expression},e.prototype.getCallExpression=function(){for(var t="",e=this.expression;e;)e instanceof BaseExpressionNode&&(t="."+e.getName()+t),e=e.getExpression();return t.slice(1)},e.prototype.accept=function(t){if(t.visitEnterCallExpression(this),this.callee&&(n=NodeFactory.createNode(this.callee))&&(n instanceof MemberExpressionNode&&(this.expression=n),n.accept(t)),this.args&&Array.isArray(this.args))for(var e=0,o=this.args;e<o.length;e++){var r=o[e],n=NodeFactory.createNode(r);if(n){var i=NodeFactory.createNode({type:"Argument",arg:n});i&&i.accept(t)}}t.visitLeaveCallExpression(this)},e}(BaseExpressionNode);exports.CallExpressionNode=CallExpressionNode;var MemberExpressionNode=function(t){function e(e,o,r,n){var i=t.call(this,"MemberExpression",n)||this;return i.object=e,i.property=o,i.computed=r,i.mlocation=n,i}return __extends(e,t),e.prototype.getObject=function(){return this.object},e.prototype.getProperty=function(){return this.property},e.prototype.getExpression=function(){return this.expression},e.prototype.getMemberExpression=function(){for(var t="",e=this.expression;e;)e instanceof BaseExpressionNode&&(t="."+e.getName()+t),e=e.getExpression();return t.slice(1)},e.prototype.accept=function(t){if(t.visitEnterMemberExpression(this),this.object&&(e=NodeFactory.createNode(this.object))&&(this.expression=e,e.accept(t)),this.property){var e=NodeFactory.createNode(this.property);e&&(e instanceof BaseExpressionNode&&this.setName(e.getName()),e.accept(t))}t.visitLeaveMemberExpression(this)},e}(BaseExpressionNode);exports.MemberExpressionNode=MemberExpressionNode;var IdentifierNode=function(t){function e(e,o){var r=t.call(this,e,o)||this;return r.iname=e,r.ilocation=o,r}return __extends(e,t),e.prototype.getName=function(){return this.iname},e.prototype.getExpression=function(){return null},e.prototype.accept=function(t){t.visitEnterIdentifier(this),t.visitLeaveIdentifier(this)},e}(BaseExpressionNode);exports.IdentifierNode=IdentifierNode;var LiteralNode=function(t){function e(e,o){var r=t.call(this,e,o)||this;return r.value=e,r.ilocation=o,r}return __extends(e,t),e.prototype.getValue=function(){return this.value},e.prototype.getExpression=function(){return null},e.prototype.accept=function(t){t.visitEnterLiteral(this),t.visitLeaveLiteral(this)},e}(BaseExpressionNode);exports.LiteralNode=LiteralNode;var NodeFactory=function(){function t(){}return t.createNode=function(t){return"Program"===t.type?new ProgramNode(t.body):"ExpressionStatement"===t.type?new ExpressionStatementNode(t.expression):"CallExpression"===t.type?new CallExpressionNode(t.callee,t.arguments):"Argument"===t.type?new ArgumentNode(t.arg):"MemberExpression"===t.type?new MemberExpressionNode(t.object,t.property,t.computed,t.location):"Identifier"===t.type?new IdentifierNode(t.name,t.location):"Literal"===t.type?new LiteralNode(t.value,t.location):void 0},t}();exports.NodeFactory=NodeFactory;var NodeVisitor=function(){return function(){}}();exports.NodeVisitor=NodeVisitor;var CodeVisitor=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.visitEnterProgram=function(t){},e.prototype.visitEnterExpressionStatement=function(t){},e.prototype.visitEnterCallExpression=function(t){},e.prototype.visitEnterArgument=function(t){},e.prototype.visitEnterMemberExpression=function(t){},e.prototype.visitEnterIdentifier=function(t){},e.prototype.visitEnterLiteral=function(t){},e.prototype.visitLeaveProgram=function(t){},e.prototype.visitLeaveExpressionStatement=function(t){},e.prototype.visitLeaveCallExpression=function(t){},e.prototype.visitLeaveArgument=function(t){},e.prototype.visitLeaveMemberExpression=function(t){},e.prototype.visitLeaveIdentifier=function(t){},e.prototype.visitLeaveLiteral=function(t){},e}(NodeVisitor);exports.CodeVisitor=CodeVisitor;var ValidatorReporter=function(){function t(){this.errors=[]}return t.prototype.report=function(t,e){this.errors.push({type:t,position:e})},t}();exports.ValidatorReporter=ValidatorReporter;var ValidatorVisitor=function(t){function e(e,o,r){var n=t.call(this)||this;return n.symbolTable=e,n.reporter=o,n.collector=r,n.types={EXPRESSION_STATEMENT:"ExpressionStatement",CALL_EXPRESSION:"CallExpression",ARGUMENT:"Argument",MEMBER_EXPRESSION:"MemberExpression",IDENTIFIER:"Identifier",LITERAL:"Literal",ACCESOR:"accessor",PROPERTY:"property"},n.expressionCount=0,n.contexts=[],n}return __extends(e,t),e.prototype.visitEnterProgram=function(t){this.expressionCount=0},e.prototype.visitLeaveProgram=function(t){},e.prototype.visitEnterExpressionStatement=function(t){this.expressionCount+=1,this.addContext({type:this.types.EXPRESSION_STATEMENT})},e.prototype.visitLeaveExpressionStatement=function(t){this.removeContext(),this.expressionCount>1&&this.reporter.report("Only one expression is allowed",t.getLocation())},e.prototype.visitEnterCallExpression=function(t){var e=this.addContext({type:this.types.CALL_EXPRESSION});e.location=t.getLocation(),e.path=[],e.arguments=[]},e.prototype.visitLeaveCallExpression=function(t){var e=this,o=this.removeContext(),r=this.getCurrentContext();if(r&&r.type===this.types.ARGUMENT&&(r.argument=o),!lodash.isEmpty(o.path)){this.collectFunctionReference(o.path);var n=this.findForPath(o.path);if(n&&"function"===n.type){if(n.args){var i=n.args||[],s=o.arguments||[];i.length!==s.length&&this.reporter.report("Expected "+i.length+" but found "+s.length,o.location),s.forEach(function(t,o){var r=i[o];r&&r.type!==t.valueType&&e.reporter.report("Expected param "+o+" to be a "+r.type+" but found "+t.valueType,t.location)})}r.argument.valueType=n.return}if(n&&"function"!==n.type){var a=o.path[o.path.length-1];this.reporter.report(a.name+" is not a function",a.location)}}},e.prototype.visitEnterArgument=function(t){this.addContext({type:this.types.ARGUMENT})},e.prototype.visitLeaveArgument=function(t){var e=this.removeContext();this.getCurrentContext().arguments.push(e.argument)},e.prototype.visitEnterMemberExpression=function(t){this.addContext({type:this.types.MEMBER_EXPRESSION}).location=t.getLocation()},e.prototype.visitLeaveMemberExpression=function(t){var e=this.removeContext(),o=this.getCurrentContext();this.accumulateInPath.apply(this,e.path),o.type===this.types.MEMBER_EXPRESSION||o.type!==this.types.CALL_EXPRESSION&&this.collectMemberReference(e.path),o.type===this.types.ARGUMENT?o.argument=e:o&&o.type===this.types.CALL_EXPRESSION&&(o.path=e.path,o.location=o.location||e.location)},e.prototype.visitEnterIdentifier=function(t){this.accumulateInPath({type:"property",name:t.getName(),location:t.getLocation()})},e.prototype.visitLeaveIdentifier=function(t){},e.prototype.visitEnterLiteral=function(t){this.getCurrentContext().type===this.types.MEMBER_EXPRESSION&&this.accumulateInPath({type:"accessor",name:t.getName(),location:t.getLocation()})},e.prototype.visitLeaveLiteral=function(t){var e=this.getCurrentContext();e.type===this.types.MEMBER_EXPRESSION?this.accumulateInPath({type:"accessor",name:t.getName(),location:t.getLocation()}):e.type===this.types.ARGUMENT&&(e.argument={type:this.types.LITERAL,valueType:this.determineValueType(t.getValue())})},e.prototype.collectFunctionReference=function(t){this.collector&&this.collector.addFunctionReference(t)},e.prototype.collectMemberReference=function(t){this.collector&&this.collector.addMemberReference(t)},e.prototype.validatePath=function(t){for(var e,o,r,n=null,i=0;i<t.length;i++)if(r=t[i],e=n,o=e?t[i-1]:null,n?n=n.children?n.children[r.name]:null:n||(n=this.symbolTable[r.name]),!n&&e?r.type===this.types.ACCESOR&&"array"===e.type?(this.reporter.report("Cannot access index of "+o.name+" (not an array)",r.location),n={type:e.type,children:e.children}):r.type===this.types.ACCESOR&&"array"!==e.type?this.reporter.report("Cannot access index of "+o.name+" (not an array)",r.location):this.canHaveSubProperties(e)?this.reporter.report("Cannot find property "+r.name+" in "+o.name,r.location):this.reporter.report("Cannot access property of an "+e.type,r.location):n||e||this.reporter.report("Cannot find name "+r.name,r.location),!n)return!1;return!0},e.prototype.findForPath=function(t){for(var e=(t=t.slice()).shift(),o=this.symbolTable[e.name];t.length>0;)if((e=t.shift()).type===this.types.ACCESOR&&(e=t.shift()),!(o=o.children[e.name]))return null;return o},e.prototype.determineValueType=function(t){return lodash.isString(t)?"string":lodash.isNumber(t)?"number":lodash.isBoolean(t)?"boolean":null},e.prototype.canHaveSubProperties=function(t){return"function"===t.type||"object"===t.type||"namespace"===t.type},e.prototype.accumulateInPath=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var o=this.getCurrentContext();o.path?(r=o.path).push.apply(r,t):o.path=t.slice();var r},e.prototype.getCurrentContext=function(){var t=this.contexts.length;return t?this.contexts[t-1]:null},e.prototype.addContext=function(t){return this.contexts.push(t),t},e.prototype.removeContext=function(){return this.contexts.pop()},e}(NodeVisitor);exports.ValidatorVisitor=ValidatorVisitor;