"use strict";var __decorate=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,c=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(c=(n<3?i(c):n>3?i(t,r,c):i(t,r))||c);return n>3&&c&&Object.defineProperty(t,r,c),c},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(exports,"__esModule",{value:!0});var wi_contrib_1=require("./wi-contrib"),core_1=require("@angular/core"),http_1=require("@angular/http"),rxjs_extensions_1=require("../../common/rxjs-extensions"),wi_contrib_map_1=require("./wi-contrib.map"),serviceurls_1=require("../shared/serviceurls"),utils_1=require("../../common/util/utils"),ContribService=function(){function e(e,t,r,o,i){this._injector=e,this.http=t,this.resolver=r,this.loader=o,this.compiler=i,this.config=wi_contrib_map_1.WiModuleContributionMap.getInstance(),this.init(t)}return e.prototype.init=function(e){var t=this,r=core_1.ReflectiveInjector.resolve([http_1.Http]),o=core_1.ReflectiveInjector.fromResolvedProviders(r);e.get(serviceurls_1.SERVICE_URLS.MODULES).map(function(e){return e.json()||{}}).subscribe(function(e){0===t.config.moduleMap.size&&(t.config.moduleMap=utils_1.jsonToStrMap(e));var r=SystemJS.getConfig();r.paths["wi-contrib:"]=System.baseURL+"wistudio/v1/contributions",t.config.moduleMap.forEach(function(e,o){null!==t.getModuleFileName(e.files)&&(r.map[e.name]="wi-contrib:/"+e.name,r.packages[e.name]={main:t.getModuleFileName(e.files),defaultExtension:"js"})}),SystemJS.config(r),t.config.moduleMap.forEach(function(e,r){null!==t.getModuleFileName(e.files)&&null===e.service&&rxjs_extensions_1.Observable.fromPromise(t.loader.load(e.name)).subscribe(function(r){rxjs_extensions_1.Observable.fromPromise(t.compiler.compileModuleAndAllComponentsAsync(r.moduleType)).subscribe(function(t){var i=r.create(o);e.service=i.injector.get(wi_contrib_1.WiServiceContribution)},function(e){})},function(e){})})},function(e){return rxjs_extensions_1.Observable.throw(e||"Server error")})},e.prototype.getModuleFileName=function(e){for(var t=0;t<e.length;t++)if(e[t].endsWith(".module.js"))return e[t];return null},e.prototype.getContributionModules=function(){var e=[];return this.config.moduleMap.forEach(function(t,r){e.push(r)}),e},e.prototype.getContributionService=function(e){return this.config.moduleMap.has(e)?this.config.moduleMap.get(e).service:null},e}();ContribService=__decorate([core_1.Injectable(),__param(1,core_1.Inject(http_1.Http)),__param(2,core_1.Inject(core_1.ComponentFactoryResolver)),__param(3,core_1.Inject(core_1.SystemJsNgModuleLoader)),__param(4,core_1.Inject(core_1.Compiler)),__metadata("design:paramtypes",[core_1.Injector,http_1.Http,core_1.ComponentFactoryResolver,core_1.SystemJsNgModuleLoader,core_1.Compiler])],ContribService),exports.ContribService=ContribService;