"use strict";var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();Object.defineProperty(exports,"__esModule",{value:!0});var rxjs_extensions_1=require("../../../../common/rxjs-extensions"),validation_1=require("../../../../common/models/validation"),validationrule_1=require("../../../../common/models/vrules/validationrule"),validation_2=require("../../../../common/models/validation"),constants_1=require("../../../../common/constants"),contribution_observable_1=require("../../../../common/models/contribution_observable"),lodash=require("lodash"),ActivityHook=function(){function t(t,e,n){this.appContext=t,this.flowContext=e,this.activityContext=n}return t.prototype.hook=function(t){var e=this;rxjs_extensions_1.Observable.from(t.getErrors()).map(function(t){var n=new Map;n.set("APPNAME",e.appContext.applicationName),n.set("APPID",e.appContext.id),n.set("FLOWNAME",e.flowContext.name),n.set("FLOWID",e.flowContext._id),n.set("ITEMNAME",e.activityContext.activityTitle),n.set("ITEMID",e.activityContext.id),t.setContext(n)}).subscribe(function(t){})},t}();exports.ActivityHook=ActivityHook;var ActivityFieldsHook=function(){function t(t,e,n,o){this.appContext=t,this.flowContext=e,this.activityContext=n,this.attribute=o}return t.prototype.hook=function(t){var e=this;rxjs_extensions_1.Observable.from(t.getErrors()).map(function(t){var n=new Map;n.set("APPNAME",e.appContext.applicationName),n.set("APPID",e.appContext.id),n.set("FLOWNAME",e.flowContext.name),n.set("FLOWID",e.flowContext._id),n.set("ITEMNAME",e.activityContext.activityTitle),n.set("ITEMID",e.activityContext.id),n.set("FIELD",e.attribute.name),t.setContext(n)}).subscribe(function(t){})},t}();exports.ActivityFieldsHook=ActivityFieldsHook;var ActivityValidationRule=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.newValidationRule=function(){return new e},e.prototype.getContribHook=function(t){return null},e.prototype.canValidate=function(t){return!0},e.prototype.getContexts=function(t){var e=t.getElements(constants_1.EnumValidationContext.APPLICATION),n=[];for(var o in e.flows){var i=e.flows[o];n=this.setFlowContext(i,t);for(var a in i.errorHandler){var s=this.setFlowContext(i.errorHandler[a],t);n=n.concat(s)}}return n},e.prototype.setFlowContext=function(t,e){var n=[];for(var o in t.items)if(t.items[o].taskType===constants_1.TASK_TYPE.TASK){n.push(lodash.cloneDeep(e)),n[n.length-1].addElement(constants_1.EnumValidationContext.FLOW,t);var i=lodash.cloneDeep(t.items[o]);n[n.length-1].addElement(constants_1.EnumValidationContext.ACTIVITY,lodash.cloneDeep(i))}return n},e.prototype.start=function(t,e){for(var n=this.getContexts(t),o=0;o<n.length;o++){var i=n[o];if(this.canValidate(i)){var a=new ActivityHook(i.getElements(constants_1.EnumValidationContext.APPLICATION),i.getElements(constants_1.EnumValidationContext.FLOW),i.getElements(constants_1.EnumValidationContext.ACTIVITY));this.validationObservables.push(contribution_observable_1.ContributionObservable.eval(this,this.validate,a,i))}if(this.canValidate(i)&&e){e=e;var s=i.getElements(constants_1.EnumValidationContext.ACTIVITY);if(s)for(var r=(s.display.category||constants_1.DEFAULT_TASK_CATEGORY)+"/"+s.name,l=e.getContributionService(r),u=i.getElements(constants_1.EnumValidationContext.ACTIVITY).inputs,c=0;c<u.length;c++){var v=new ActivityFieldsHook(i.getElements(constants_1.EnumValidationContext.APPLICATION),i.getElements(constants_1.EnumValidationContext.FLOW),i.getElements(constants_1.EnumValidationContext.ACTIVITY),u[c]);if(this.validationObservables.push(contribution_observable_1.ContributionObservable.eval(this,this.fieldValidation,v,u[c])),l){var d=l.getValidationProvider(u[c].name);if(d){var p=lodash.cloneDeep(i.getElements(constants_1.EnumValidationContext.ACTIVITY));p.appId=i.getElements(constants_1.EnumValidationContext.APPLICATION).id,this.validationObservables.push(contribution_observable_1.ContributionObservable.eval(d,d.validate,v,p))}}}else constants_1.FLOW_DIAGRAM_DEBUG}}return this.validationObservables},e.prototype.validate=function(t){return rxjs_extensions_1.Observable.create(function(t){t.next(validation_2.ValidationResult.newValidationResult()),t.complete()})},e.prototype.fieldValidation=function(t){var e=this;return rxjs_extensions_1.Observable.create(function(n){var o=validation_2.ValidationResult.newValidationResult();e.isVisible(t)&&t.required&&(void 0===t.value||t.value.trim&&""===t.value.trim())&&o.errors.push(validation_1.ValidationError.newError("500","Error: "+t.name+" is required")),n.next(o),n.complete()})},e.prototype.isVisible=function(t){return!!t.display&&lodash.get(t,"display.visible",!0)},e}(validationrule_1.AbstractValidationRule);exports.ActivityValidationRule=ActivityValidationRule;