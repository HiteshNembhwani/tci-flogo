"use strict";var __extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();Object.defineProperty(exports,"__esModule",{value:!0});var contribution_observable_1=require("../../../../common/models/contribution_observable"),lodash=require("lodash"),rxjs_extensions_1=require("../../../../common/rxjs-extensions"),validation_1=require("../../../../common/models/validation"),validationrule_1=require("../../../../common/models/vrules/validationrule"),validation_2=require("../../../../common/models/validation"),constants_1=require("../../../../common/constants"),TriggerHook=function(){function t(t,e,n){this.appContext=t,this.flowContext=e,this.triggerContext=n}return t.prototype.hook=function(t){var e=this;rxjs_extensions_1.Observable.from(t.getErrors()).map(function(t){var n=new Map;n.set("APPNAME",e.appContext.applicationName),n.set("APPID",e.appContext.id),n.set("FLOWNAME",e.flowContext.name),n.set("FLOWID",e.flowContext._id),n.set("ITEMNAME",e.triggerContext.activityTitle),n.set("ITEMID",e.triggerContext.id),t.setContext(n)}).subscribe(function(t){})},t}();exports.TriggerHook=TriggerHook;var TriggerFieldsHook=function(){function t(t,e,n,o){this.appContext=t,this.flowContext=e,this.triggerContext=n,this.attribute=o}return t.prototype.hook=function(t){var e=this;rxjs_extensions_1.Observable.from(t.getErrors()).map(function(t){var n=new Map;n.set("APPNAME",e.appContext.applicationName),n.set("APPID",e.appContext.id),n.set("FLOWNAME",e.flowContext.name),n.set("FLOWID",e.flowContext._id),n.set("ITEMNAME",e.triggerContext.activityTitle),n.set("ITEMID",e.triggerContext.id),n.set("FIELD",e.attribute.name),t.setContext(n)}).subscribe(function(t){})},t}();exports.TriggerFieldsHook=TriggerFieldsHook;var TriggerValidationRule=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.newValidationRule=function(){return new e},e.prototype.getContribHook=function(t){return null},e.prototype.canValidate=function(t){return!0},e.prototype.getContexts=function(t){var e=t.getElements(constants_1.EnumValidationContext.APPLICATION),n=[];for(var o in e.flows){var i=e.flows[o];n.push(lodash.cloneDeep(t)),n[n.length-1].addElement(constants_1.EnumValidationContext.FLOW,i);for(var a in e.flows[o].items)if(e.flows[o].items[a].taskType===constants_1.TASK_TYPE.TASK_ROOT){n[n.length-1].addElement(constants_1.EnumValidationContext.TRIGGER,lodash.cloneDeep(e.flows[o].items[a]));break}}return n},e.prototype.start=function(t,e){for(var n=this.getContexts(t),o=0;o<n.length;o++){var i=n[o];if(this.canValidate(i)){var a=new TriggerHook(i.getElements(constants_1.EnumValidationContext.APPLICATION),i.getElements(constants_1.EnumValidationContext.FLOW),i.getElements(constants_1.EnumValidationContext.TRIGGER));this.validationObservables.push(contribution_observable_1.ContributionObservable.eval(this,this.validate,a,i))}if(this.canValidate(i)&&e){e=e;var r=i.getElements(constants_1.EnumValidationContext.TRIGGER);if(r){r.display.category||constants_1.DEFAULT_TASK_CATEGORY,r.name;for(var s=e.getContributionService(r),l=i.getElements(constants_1.EnumValidationContext.TRIGGER).settings.concat(i.getElements(constants_1.EnumValidationContext.TRIGGER).handler.settings),u=0;u<l.length;u++){var c=new TriggerFieldsHook(i.getElements(constants_1.EnumValidationContext.APPLICATION),i.getElements(constants_1.EnumValidationContext.FLOW),i.getElements(constants_1.EnumValidationContext.TRIGGER),l[u]);if(this.validationObservables.push(contribution_observable_1.ContributionObservable.eval(this,this.fieldValidation,c,l[u])),s)try{var d=s.getValidationProvider(l[u].name);if(d){var p=lodash.cloneDeep(i.getElements(constants_1.EnumValidationContext.TRIGGER));p.appId=i.getElements(constants_1.EnumValidationContext.APPLICATION).id,this.validationObservables.push(contribution_observable_1.ContributionObservable.eval(d,d.validate,c,p))}}catch(t){}}}}}return this.validationObservables},e.prototype.validate=function(t){return rxjs_extensions_1.Observable.create(function(t){t.next(validation_2.ValidationResult.newValidationResult()),t.complete()})},e.prototype.fieldValidation=function(t){var e=this;return rxjs_extensions_1.Observable.create(function(n){var o=validation_2.ValidationResult.newValidationResult();e.isVisible(t)&&t.required&&(void 0===t.value||t.value.trim&&""===t.value.trim())&&o.errors.push(validation_1.ValidationError.newError("500","Error: "+t.name+" is required")),n.next(o),n.complete()})},e.prototype.isVisible=function(t){return!t.display||!1!==t.display.visible},e}(validationrule_1.AbstractValidationRule);exports.TriggerValidationRule=TriggerValidationRule;