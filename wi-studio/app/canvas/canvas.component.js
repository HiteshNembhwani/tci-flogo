"use strict";function taskChildCounter(e,t,i){var a=0,s=e.getFlowById(t);return lodash.forEach(s.paths.nodes,function(o,r){if(o===i)for(var n in o.children){s.paths.nodes[o.children[n]].type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE&&a++;var l=s.paths.nodes[o.children[n]];a+=taskChildCounter(e,t,l)}}),a}function getTaskNodeBranches(e,t,i){var a=[],s=e.getFlowById(t);return lodash.forEach(s.paths.nodes,function(e,t){if(e.taskID===i)for(var o in e.children)s.paths.nodes[e.children[o]].type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH&&a.push(s.paths.nodes[e.children[o]].taskID)}),a}var __decorate=this&&this.__decorate||function(e,t,i,a){var s,o=arguments.length,r=o<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,i):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,a);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(r=(o<3?s(r):o>3?s(t,i,r):s(t,i))||r);return o>3&&r&&Object.defineProperty(t,i,r),r},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var validation_service_1=require("./../shared/services/validation/validation.service"),wi_contrib_service_1=require("../contrib/wi-contrib.service"),validationrule_1=require("../../common/models/vrules/validationrule"),angular2_notifications_1=require("angular2-notifications"),app_model_1=require("../../common/models/app/app.model"),flowService_1=require("./../shared/services/flowService"),core_1=require("@angular/core"),router_1=require("@angular/router"),http_1=require("@angular/http"),constants_1=require("../../common/constants"),constants_2=require("../../common/constants"),constants_3=require("../../common/constants"),diagram_model_1=require("./../diagram/models/diagram.model"),constants_4=require("./../../common/constants"),common_1=require("@angular/common"),canvas_service_1=require("./canvas.service"),TCIServices_1=require("./../shared/services/TCIServices"),map_input_schema_provider_1=require("./../mapper/service/map.input.schema.provider"),map_parser_1=require("./../mapper/service/map.parser"),map_context_validator_1=require("./../mapper/service/map.context.validator"),map_function_lookup_1=require("./../mapper/service/map.function.lookup"),map_output_schema_provider_1=require("./../mapper/service/map.output.schema.provider"),mapper_context_1=require("./../mapper/service/mapper.context"),messaging_1=require("./../../common/services/messaging"),lodash=require("lodash"),d3=require("d3"),flowsList_service_1=require("../flowslist/flowsList.service"),palette_service_1=require("../shared/services/palette.service"),constants_5=require("../../common/constants");exports.TEMPL={IDS:{diagramContainer:"diagramContainer",diagramHandlerSwitch:"diagramHandlerSwitch",flowContainer:"flowContainer",paletteContainer:"paletteContainer",propertyPaletteContainer:"propertyPaletteContainer",paletteContainerArrow:"propertyPaletteContainerArrow"},CLS:{propertyPalettePlacer:"property-palette-placer"}};var CanvasComponent=function(){function e(e,t,i,a,s,o,r,n,l,p,c,d,h,_,u,m,f){var v=this;this._service=e,this._router=t,this.http=i,this.route=a,this.flowService=s,this.flowListService=o,this._notifService=r,this._tciServices=n,this.location=l,this.paletteService=p,this.contribService=c,this.validationService=d,this.outputSchema=h,this.functionsLookup=_,this.contextValidator=u,this.inputSchema=m,this.mappingpparser=f,this.pushed=new core_1.EventEmitter,this.TEMPL=exports.TEMPL,this.options={position:["bottom","right"],timeOut:5e3,lastOnBottom:!0,maxStack:3,preventDuplicates:!0,theClass:"wi-simple-notification"},this.currentDiagramHandler=this.getFlowDiagramHandlerDataMain(),this.flows=[],this.propertyPaletteCollapsed=!0,this.showTaskPropertiesPending=!1,this.taskToDeleteChildCount=0,this.taskToDeleteLabel="",this.taskToDeleteAnimated=!1,this.displayDeleteTaskModal=!1,this.displayBranchMappingModal=!1,a.params.subscribe(function(t){var i=t.appId,a=t.flowId,s=t.sandboxId;e.setMainFlowId(a),v._service._msg.emit(constants_2.APP_MESSAGING_VALUES.UNSELECTED_TASK,{}),v.app&&i===v.app.id&&s===v.sandboxId?a!==v.flowId&&(v.flowId=a,v.flow=v.app.getFlowById(a),v.setCurrentMainFlow()):(v.sandboxId=s,v.flowId=a,v.getFlow(i))}),this.initSubscriptions()}return e.prototype.initSubscriptions=function(){var e=this;this._service._msg.on(constants_2.APP_MESSAGING_VALUES.ADD_TASK,function(t){lodash.isUndefined(t.id)||(e._service._msg.emit(constants_2.APP_MESSAGING_VALUES.ADD_TASK_DONE,t),e.selectedTaskExecute(t.id))}),this._service._msg.on(constants_2.APP_MESSAGING_VALUES.CLOSE_PALETTE,function(){e.doPropertyPaletteCollapse()}),this._service._msg.on(constants_2.APP_MESSAGING_VALUES.OPEN_TASK_PROPERTIES,function(t){e.showTaskPropertiesPendingId=t,e.flow?e.showSelectedTaskProperties():e.showTaskPropertiesPending=!0}),this._service._msg.on(constants_2.APP_MESSAGING_VALUES.DIAGRAM_FLOW_RENDERED,function(t){e.showTaskPropertiesPending&&e.showSelectedTaskProperties();for(var i in e.flow.items)e.flow.items[i].taskType===constants_4.TASK_TYPE.TASK_BRANCH&&(e.mappingBranch=e.flow.items[i],e.brancMappingEvaluate());e.mappingBranch=void 0}),this._service._msg.on(constants_2.APP_MESSAGING_VALUES.BRANCH_SELECTED,function(t){var i=function(){return e._service._msg.emit(constants_2.APP_MESSAGING_VALUES.BRANCH_SELECTED,t)};e.flowId!==t.flowId?e.openFlow(t.flowId).then(i):e.flow.items[t.taskId]?e.openBranchMappingsModal(t.taskId):(e.currentDiagramHandlerSwitch(),i())}),this._service._msg.on(constants_2.APP_MESSAGING_VALUES.NODE_ADD,function(t){var i=function(){return e._service._msg.emit(constants_2.APP_MESSAGING_VALUES.NODE_ADD,t)};e.flowId!==t.flowId?e.openFlow(t.flowId).then(i):e.flow.paths.nodes[t.nodeId]||(e.currentDiagramHandlerSwitch(),i())})},e.prototype.triggerValidations=function(){var e=validationrule_1.ValidationContext.newContext();e.addElement(constants_5.EnumValidationContext.APPLICATION,lodash.cloneDeep(this.app)),this.validationService.start(e,this.contribService).subscribe(function(e){})},e.prototype.getFlow=function(e){var t=this;this.flowService.getAppDetails(e).subscribe(function(e){t.app=new app_model_1.AppModel(e),t.originalApp=lodash.cloneDeep(t.app),t.flow=t.app.getFlowById(t.flowId),t.flowIds=Object.keys(t.app.flows),lodash.isEmpty(t.flow)||lodash.isEmpty(t.flow.paths)&&(t.flow.paths={root:{},nodes:{}}),t.setCurrentMainFlow()})},e.prototype.setCurrentMainFlow=function(){this._service.setAppModel(this.app),this._service.setCurrentFlow(this.flow,this.currentDiagramHandler.type),this.currentDiagramHandlerSet(!0),this.currentDiagramHandler=this.getFlowDiagramHandlerDataMain(),this.triggerValidations(),this._service._msg.emit(constants_2.APP_MESSAGING_VALUES.FLOW_CHANGED,{flow:this.flow,type:this.currentDiagramHandler.type})},e.prototype.addTask=function(e){this._router.navigate(["./add"],{relativeTo:this.route}),this._service.setSelectedTask(void 0),this.doPropertyPaletteExpand()},e.prototype.selectTask=function(e){var t=e.detail.node.taskID;switch(e.detail.node.type){case constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT:case constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT_ERROR_NEW:case constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE:this._router.navigate(["./task",t],{relativeTo:this.route});break;case constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH:this.openBranchMappingsModal(t);break;default:constants_3.FLOW_DIAGRAM_DEBUG,this.cleanRoute(),!1}},e.prototype.openBranchMappingsModal=function(e){this.doPropertyPaletteCollapse();var t=new Map;this.mappingBranch=lodash.cloneDeep(this._service.getTask(e)),t.app=this._service.getAppModel(),t.flow=this._service.getCurrentFlow(),t.node=this._service.getNode(e),t.functionLookup=this.functionsLookup,t.contextValidator=this.contextValidator,t.outputSchema=this.outputSchema,t.inputSchema=this.inputSchema,t.expressionParser=this.mappingpparser,t.messaging=new messaging_1.AppMessaging,t.mapping=this.mappingBranch.inputMappings,this.mapperContext=new mapper_context_1.MapperContext(t),this.displayBranchMappingModal=!0},e.prototype.selectedTaskExecute=function(e){var t=this._service.getSelectedTask();if(lodash.isUndefined(t)||e!==t.id){var i=this.flow.items[e];this._service.setSelectedTask(i),this._service._msg.emit(constants_2.APP_MESSAGING_VALUES.TASK_SELECTED,i)}},e.prototype.cleanRoute=function(){this._router.navigate(["task"],{relativeTo:this.route})},e.prototype.onMenuItemClicked=function(e){var t=e.detail.node.taskID,i=e.detail.origEvent.target.getAttribute(diagram_model_1.DATA_ATTR.dataMenuItemType);switch(lodash.isEmpty(i)&&constants_3.FLOW_DIAGRAM_DEBUG,Number(i)){case constants_1.FLOW_DIAGRAM_NODE_MENU_ITEM_TYPE.ADD_BRANCH:constants_3.FLOW_DIAGRAM_DEBUG;var a=this.app.addBranch(this.flow._id,t);this._service.saveApp(),this._service._msg.emit(constants_2.APP_MESSAGING_VALUES.ADD_TASK_DONE,t),d3.selectAll("["+diagram_model_1.DATA_ATTR.dataTaskId+"='"+a+"']").node().nextSibling.click();break;case constants_1.FLOW_DIAGRAM_NODE_MENU_ITEM_TYPE.SELECT_TRANSFORM:constants_3.FLOW_DIAGRAM_DEBUG;break;case constants_1.FLOW_DIAGRAM_NODE_MENU_ITEM_TYPE.DELETE:constants_3.FLOW_DIAGRAM_DEBUG,this.deleteTaskAnalysis(t)}},e.prototype.openFlow=function(e){return this._router.navigate(["/wistudio/flow/",this.sandboxId,this.app.id,e])},e.prototype.goToAppDetails=function(){this._router.navigate(["/applicationsdetail"],{queryParams:{sandboxId:this.sandboxId,appId:this.app.id}})},e.prototype.showSelectedTaskProperties=function(){var e=this;if(this.flow.items[this.showTaskPropertiesPendingId]){var t=this.flow.items[this.showTaskPropertiesPendingId];this.showTaskPropertiesPending=!1,this.showTaskPropertiesPendingId=void 0,this._service.setSelectedTask(t),this.doPropertyPaletteShow(t.id),this._service._msg.emit(constants_2.APP_MESSAGING_VALUES.TASK_SELECTED,t)}else{var i=this;for(var a in this.flow.errorHandler)!function(t){i.flow.errorHandler[t].items[i.showTaskPropertiesPendingId]&&setTimeout(function(){e.currentDiagramHandlerSet(!1,t),e._service._msg.emit(constants_2.APP_MESSAGING_VALUES.OPEN_TASK_PROPERTIES,e.showTaskPropertiesPendingId)})}(a)}},e.prototype.doPropertyPaletteShow=function(e){this.getTaskElement(e)&&(this.selectedTaskExecute(e),this.doPropertyPaletteExpand(e))},e.prototype.doPropertyPaletteCollapse=function(){this.propertyPaletteCollapsed=!0,this.unSelectTask()},e.prototype.doPropertyPaletteExpand=function(e){this.propertyPaletteCollapsed=!1,this.elementSelectedPropertyPaletteArrow(e)},e.prototype.unSelectTask=function(){this._service._msg.emit(constants_2.APP_MESSAGING_VALUES.UNSELECTED_TASK,{}),this.cleanRoute()},e.prototype.elementSelectedPropertyPaletteArrow=function(e,t){var i=this;t=t||!0;var a={behavior:"smooth"},s=e?this.getTaskElement(e):this._service.taskEventHelper.target,o=s.getBoundingClientRect();d3.select(s).classed(diagram_model_1.CLS.diagramNodeStatusSelected,!0);var r=document.getElementById(exports.TEMPL.IDS.flowContainer),n=r.getBoundingClientRect();if(t){var l=r.scrollLeft+n.width;if(o.left>l)return r.scrollLeft=o.left+o.width/2,void setTimeout(function(){return i.elementSelectedPropertyPaletteArrow(e,!1)})}for(var p=d3.select("#"+exports.TEMPL.IDS.paletteContainer),c=document.getElementById(exports.TEMPL.IDS.paletteContainerArrow),d=document.getElementsByClassName(""+diagram_model_1.CLS.diagramRow),h=r.scrollLeft,_=0,u=d.length-1;u<=d.length;u--)if(d[u]===s.parentNode){_+=(u-d.length+1)*s.parentElement.getBoundingClientRect().height;break}p.style("top",_+"px").style("left",h+"px"),r.scrollTop=r.scrollHeight+999,setTimeout(function(){var e=-n.left-+d3.select("."+diagram_model_1.CLS.diagramRow).style("padding-left").replace("px","")+c.getBoundingClientRect().height+o.left+o.width/2-+p.style("left").replace("px","");d3.select(c).style("left",e+h-8+"px");var t=document.getElementById(exports.TEMPL.IDS.propertyPaletteContainer),i=t.getBoundingClientRect();(i.bottom>window.innerHeight||i.top<0)&&t.scrollIntoView(a)})},e.prototype.deleteTaskAnalysis=function(e){this.taskToDeleteId=e,this.taskToDeleteChildCount=0;if(this.flow.items[e].taskType===constants_4.TASK_TYPE.TASK){this.taskToDeleteLabel="task";var t=getTaskNodeBranches(this.app,this.flow._id,e);for(var i in t){s=void 0;for(var a in this.flow.paths.nodes)this.flow.paths.nodes[a].taskID===t[i]&&(s=this.flow.paths.nodes[a]);this.taskToDeleteChildCount+=taskChildCounter(this.app,this.flow._id,s)}}else{this.taskToDeleteLabel="branch";var s=void 0;for(var a in this.flow.paths.nodes)this.flow.paths.nodes[a].taskID===e&&(s=this.flow.paths.nodes[a]);this.taskToDeleteChildCount+=taskChildCounter(this.app,this.flow._id,s)}0===this.taskToDeleteChildCount?(this.taskToDeleteAnimated=this.flow.items[e].taskType===constants_4.TASK_TYPE.TASK,this.flow.items[e].taskType===constants_4.TASK_TYPE.TASK_BRANCH&&this.doPropertyPaletteCollapse(),this.deleteTaskProceed()):(this.taskToDeleteAnimated=!1,this.displayDeleteTaskModal=!0)},e.prototype.deleteTaskCancel=function(){this.taskToDeleteId=void 0,this.displayDeleteTaskModal=!1},e.prototype.deleteTaskProceed=function(){var e=this;if(this.displayDeleteTaskModal=!1,this.taskToDeleteAnimated){this._service.removeActivityTitleControl(this.taskToDeleteId,this.flow._id);var t=diagram_model_1.CLS.diagramNodeMenu;this.doPropertyPaletteCollapse(),this.cleanRoute();var i=d3.select("["+diagram_model_1.DATA_ATTR.dataTaskId+"='"+this.taskToDeleteId+"']");i.classed("deleting",!0).select("."+t).classed("hidden",!0);setTimeout(function(){i.classed("afterDelete",!0),e.app.deleteActivity(e.flow._id,e.taskToDeleteId),e._service.saveApp(),e._service._msg.emit(constants_2.APP_MESSAGING_VALUES.TASK_DELETED,e.taskToDeleteId),i.classed("deleting",!1),setTimeout(function(){i.classed("afterDelete",!1).select("."+t).classed("hidden",!1)},200)},200)}else this.doPropertyPaletteCollapse(),this.app.deleteActivity(this.flow._id,this.taskToDeleteId),this._service.saveApp(),this._service._msg.emit(constants_2.APP_MESSAGING_VALUES.TASK_DELETED,this.taskToDeleteId)},e.prototype.changeFlowDetail=function(e,t){if("name"===t&&this.flowIds.length>1){var i=void 0;for(i=0;i<this.flowIds.length;i++){if(this.flowId===this.flowIds[i]&&e===this.originalApp.flows[this.flowId].name){this.getFlow(this.app.id);break}if(e===this.originalApp.flows[this.flowIds[i]].name){this._notifService.info("Error","Name not allowed as other flow has same name"),this.getFlow(this.app.id);break}}i===this.flowIds.length&&(this.originalApp=lodash.cloneDeep(this.app),this._service.saveApp())}else this.originalApp=lodash.cloneDeep(this.app),this._service.saveApp()},e.prototype.pushApp=function(){var e=this;this.flowListService.pushApp(this.app).subscribe(function(t){void 0!==t.id?e.flowListService.getMetaData(t.id).subscribe(function(t){if(void 0!==t.manifest){var i={manifestFile:t.manifest,applicationFile:t.appJson};e.diagramLaunchTCI(i)}else e.diagramTransactionsErroHandler({stack:"Metadata malformed"}),constants_3.FLOW_DIAGRAM_DEBUG},e.diagramTransactionsErroHandler):e.diagramTransactionsErroHandler({stack:"Unidentified response"})},this.diagramTransactionsErroHandler)},e.prototype.diagramTransactionsErroHandler=function(e){constants_3.FLOW_DIAGRAM_DEBUG},e.prototype.diagramLaunchTCI=function(e){var t=this,i=this.sandboxId;i&&(e.sandboxId=i,this._tciServices.getService("ApplicationService").pushApp(e).then(function(e){t.app.appChanges++,t._router.navigate(["/applications"])},function(e){t._notifService.error("Error",e.data.errorDetail)}))},e.prototype.revertApp=function(){this.getAppData(!0)},e.prototype.getAppData=function(e){var t=this;this.flows=[];var i=this.app.id;e&&(i="PUSHVERSION:"+this.app.id),this.flowListService.getFlowsList(i).subscribe(function(i){e&&(i.id=i.id.replace("PUSHVERSION:","")),t.app=new app_model_1.AppModel(i),e&&t.flowListService.putApp(t.app).subscribe(function(e){constants_3.FLOW_DIAGRAM_DEBUG,t.app.flows[t.flowId]?(t.flow=t.app.flows[t.flowId],t.flowIds=Object.keys(t.app.flows),t.setCurrentMainFlow()):t.goToAppDetails()},t.diagramTransactionsErroHandler)},this.diagramTransactionsErroHandler)},e.prototype.getTaskElement=function(e){return document.querySelector("["+diagram_model_1.DATA_ATTR.dataTaskId+'="'+e+'"]')},e.prototype.currentDiagramHandlerSwitch=function(){if("flow"===this.currentDiagramHandler.type){var e=void 0;if(this.flow.errorHandler&&0!==this.flow.errorHandler.size)e=this.flow.errorHandler[Object.keys(this.flow.errorHandler)[0]];else{var t=this.errorHandlerTriggerCreate();e=this.app.addErrorHandler(this.flowId,t),this._service.saveApp()}this.currentDiagramHandlerSet(!1,e._id)}else this.currentDiagramHandlerSet(!0);this.doPropertyPaletteCollapse()},e.prototype.currentDiagramHandlerSet=function(e,t){var i=!1;e?(this.currentDiagramHandler=this.getFlowDiagramHandlerDataMain(),i=!0):t&&this.flow.errorHandler[t]&&(this.currentDiagramHandler=this.getFlowDiagramHandlerDataError(t),i=!0),i&&this.flow._id!==this.currentDiagramHandler.flow._id&&(this.flow=this.currentDiagramHandler.flow,this._service.setCurrentFlow(this.currentDiagramHandler.flow,this.currentDiagramHandler.type))},e.prototype.errorHandlerTriggerCreate=function(){function e(e){for(var t in e)if("tibco-wi-error"===e[t].name)return e[t]}this.paletteService.getSchemasFromServer().subscribe(function(t){return e(t)})},e.prototype.getFlowDiagramHandlerDataMain=function(){var e;return this.app&&this.app.flows&&(e=this.app.flows[this.flowId]),{type:"flow",label:"Error handler",flow:e}},e.prototype.getFlowDiagramHandlerDataError=function(e){var t;return this.app&&this.app.flows&&(t=this.flow.errorHandler[e]),{type:"errorHandler",label:"Return to main flow",flow:t}},e.prototype.onMappingsChange=function(e){this._service.updateMappings(this.mappingBranch.id,e)},e.prototype.branchMappingModalClose=function(){this.displayBranchMappingModal=!1,this.brancMappingEvaluate()},e.prototype.brancMappingEvaluate=function(){var e=this._service.getTask(this.mappingBranch.id),t=lodash.get(e,"inputMappings.mappings.condition.expression"),i=this.getTaskElement(e.id);t&&t.trim().length>0?i.classList.add(diagram_model_1.CLS.diagramNodeHasValue):i.classList.remove(diagram_model_1.CLS.diagramNodeHasValue),this.mappingBranch=this.mapperContext=void 0},e}();__decorate([core_1.Output(),__metadata("design:type",Object)],CanvasComponent.prototype,"pushed",void 0),CanvasComponent=__decorate([core_1.Component({selector:"canvas-container",moduleId:module.id,templateUrl:"canvas.component.html",styleUrls:["../create-flow/less/create-flow.css","styles/canvas.component.css","styles/canvas.temporary.css","styles/flow.header.css"],providers:[common_1.Location,{provide:common_1.LocationStrategy,useClass:common_1.PathLocationStrategy}]}),__metadata("design:paramtypes",[canvas_service_1.CanvasService,router_1.Router,http_1.Http,router_1.ActivatedRoute,flowService_1.FlowService,flowsList_service_1.FlowsListService,angular2_notifications_1.NotificationsService,TCIServices_1.TCIServices,common_1.Location,palette_service_1.PaletteService,wi_contrib_service_1.ContribService,validation_service_1.ValidationService,map_output_schema_provider_1.ScopedOutputSchemaProvider,map_function_lookup_1.FunctionsLookup,map_context_validator_1.MapContextValidator,map_input_schema_provider_1.ContextInputSchemaProvider,map_parser_1.MappingParser])],CanvasComponent),exports.CanvasComponent=CanvasComponent;