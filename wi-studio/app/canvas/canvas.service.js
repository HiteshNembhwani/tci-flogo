"use strict";var __decorate=this&&this.__decorate||function(t,i,e,o){var r,s=arguments.length,n=s<3?i:null===o?o=Object.getOwnPropertyDescriptor(i,e):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,i,e,o);else for(var l=t.length-1;l>=0;l--)(r=t[l])&&(n=(s<3?r(n):s>3?r(i,e,n):r(i,e))||n);return s>3&&n&&Object.defineProperty(i,e,n),n},__metadata=this&&this.__metadata||function(t,i){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,i)},__param=this&&this.__param||function(t,i){return function(e,o){i(e,o,t)}};Object.defineProperty(exports,"__esModule",{value:!0});var TCIServices_1=require("./../shared/services/TCIServices"),core_1=require("@angular/core");require("rxjs/add/observable/of"),require("rxjs/add/operator/map"),require("rxjs/add/operator/catch");var flowService_1=require("../shared/services/flowService"),messaging_1=require("../../common/services/messaging"),constants_1=require("../../common/constants"),CanvasService=function(){function t(t,i){var e=this;this._flowService=t,this.tciService=i,this.activityControl={},this.AUTO_SAVE_TIME=2e3,this._msg=new messaging_1.AppMessaging({}),this._msg.on(constants_1.APP_MESSAGING_VALUES.ADD_TASK,function(t){e.saveApp()}),this._msg.on(constants_1.APP_MESSAGING_VALUES.UNSELECTED_TASK,function(t){e.selectedTask=void 0}),t.getConfiguration().subscribe(function(t){e.AUTO_SAVE_TIME=t.save_frequence_millis})}return t.prototype.getAutoSaveConfig=function(){return this.AUTO_SAVE_TIME},t.prototype.updateItemToAppModel=function(t,i){this.appModel.getFlowById(t).items[i.id]=i},t.prototype.setAppModel=function(t){var i=this;this.appModel=t,this.tciService.AppMessaging.dispose(constants_1.APP_MESSAGING_VALUES.UPDATE_MAPPING),this.tciService.AppMessaging.on(constants_1.APP_MESSAGING_VALUES.UPDATE_MAPPING,function(t){var e=i.appModel.flows[t.flowId].items[t.activityId];if(!e)for(var o in i.appModel.flows[t.flowId].errorHandler)if(e=i.appModel.flows[t.flowId].errorHandler[o].items[t.activityId])break;if(1===t.mappingsPath.length)delete e.inputMappings.mappings[t.mappingsPath[0]];else{var r=e.inputMappings.mappings[t.mappingsPath[0]],s=void 0;for(s=1;s<t.mappingsPath.length-1;s++)r=r.mappings[t.mappingsPath[s]];delete r.mappings[t.mappingsPath[s]]}i.appModel.appChanges++,i._flowService.saveApp(i.appModel,!0)})},t.prototype.getAppModel=function(){return this.appModel},t.prototype.setCurrentFlow=function(t,i){this.currentFlow=t,this._msg.emit(constants_1.APP_MESSAGING_VALUES.FLOW_CHANGED,{flow:t,type:i})},t.prototype.getCurrentFlow=function(){return this.currentFlow},t.prototype.getNode=function(t){for(var i in this.currentFlow.paths.nodes)if(this.currentFlow.paths.nodes[i].taskID===t)return this.currentFlow.paths.nodes[i];for(var e in this.currentFlow.errorHandler)for(var i in this.currentFlow.errorHandler[e].paths.nodes)if(this.currentFlow.errorHandler[e].paths.nodes[i].taskID===t)return this.currentFlow.errorHandler[e].paths.nodes[i]},t.prototype.getTask=function(t){return this.currentFlow.items[t]},t.prototype.updateMappings=function(t,i){this.currentFlow.items[t].inputMappings=i,this.saveApp()},t.prototype.setSelectedTask=function(t){this.selectedTask=t},t.prototype.getSelectedTask=function(){return this.selectedTask},t.prototype.setDiagramFlow=function(t){this.diagramFlow=t},t.prototype.getDiagramFlow=function(){return this.diagramFlow},t.prototype.setMainFlowId=function(t){this.mainFlowId=t},t.prototype.getMainFlowId=function(){return this.mainFlowId},t.prototype.setupActivitiesFlowsControl=function(){if(this.appModel&&this.appModel.flows&&this.currentFlow&&this.currentFlow._id)for(var t in this.appModel.flows)if(this.appModel.flows.hasOwnProperty(t)&&t===this.currentFlow._id){var i=this.appModel.flows[t];this.setupFlowActivitiesTitle(i);for(var e=i;e.errorHandler;){var o=e.errorHandler,r=Object.keys(o)[0];o.hasOwnProperty(r)&&(e=o[r],this.setupFlowActivitiesTitle(e))}break}},t.prototype.setupActivityDetailTitle=function(t,i){var e="";this.setActivityTitle(t,i);var o=this.getControlActivityTitle(t,i);return o?(e=o,this.setupActivityTitleCounter(i,e,!1)):(e=this.getActivityTitle(t,i),t.title=e,this.saveApp(!0)),this._msg.emit(constants_1.APP_MESSAGING_VALUES.TASK_NAME_UPDATED,t),e},t.prototype.setupActivitiesFlowControl=function(t){this.activityControl[t]||(this.activityControl[t]={titlesControl:{},titlesExist:{},titlesClearList:{},initCompleted:!1})},t.prototype.getActivityTitle=function(t,i){var e=t.title,o=t.id,r=this.activityControl[i].titlesControl[o],s=this.getTitleClear(e);if(void 0===r){this.setupActivityTitleCounter(i,s,!0);var n=this.getGlobalActivityTitleCounter(s);s+=n-1>0?n-1:"",s=this.getTitleByActivityExistance(s,t,i),this.activityControl[i].titlesControl[o]=s}else s=r;return s},t.prototype.existActivityTitle=function(t,i){var e=!1;if(this.activityControl[i])for(var o in this.activityControl)if(this.activityControl.hasOwnProperty(o)){for(var r in this.activityControl[o].titlesControl)if(this.activityControl[o].titlesControl.hasOwnProperty(r)&&(e=t===this.activityControl[o].titlesControl[r]))break;if(e)break}return e},t.prototype.removeActivityTitleControl=function(t,i){if(this.activityControl[i]&&this.activityControl[i].titlesControl[t]){var e=this.appModel.getFlowById(i).items[t],o=this.getTitleClear(e.title),r=this.activityControl[i].titlesExist[o];void 0!==r&&r>0&&r--;var s=this.activityControl[i].titlesControl[t];delete this.activityControl[i].titlesControl[t],s!==o&&delete this.activityControl[i].titlesExist[s]}},t.prototype.setupUpdatedFlowActivityTitle=function(t,i){this.activityControl[t].titlesControl[i.id]=i.title;var e=this.getTitleClear(i.title);this.setupActivityTitleCounter(t,e,!0)},t.prototype.saveApp=function(t){t||this.appModel.appChanges++,this._flowService.saveApp(this.appModel)},t.prototype.setupFlowActivitiesTitle=function(t){if(t&&t.items&&(this.setupActivitiesFlowControl(t._id),!this.activityControl[t._id].initCompleted)){for(var i in t.items)if(t.items.hasOwnProperty(i)){var e=t.items[i];this.setupActivityDetailTitle(e,t._id),this.setupActivityTitleClearControl(e,t._id)}this.crossFlowsActivitiesTitlesCounters(t._id),this.activityControl[t._id].initCompleted=!0}},t.prototype.crossFlowsActivitiesTitlesCounters=function(t){if(this.activityControl.hasOwnProperty(t)){var i=this.activityControl[t];if(i.titlesExist&&i.titlesClearList)for(var e in i.titlesClearList)i.titlesClearList.hasOwnProperty(e)&&(i.titlesExist[e]=i.titlesClearList[e])}},t.prototype.setupActivityTitleClearControl=function(t,i){if(this.activityControl.hasOwnProperty(i)){var e=this.getTitleClear(t.title),o=this.activityControl[i];if(o){var r=o.titlesClearList,s=r[e];void 0===s?r[e]=1:(s++,r[e]=s)}}},t.prototype.setActivityTitle=function(t,i){t.title&&t.title.trim().length>0&&(this.activityControl[i].titlesControl[t.id]=t.title)},t.prototype.getControlActivityTitle=function(t,i){return this.activityControl[i].titlesControl[t.id]},t.prototype.getTitleClear=function(t){return t.replace(/\s/g,"")},t.prototype.setupActivityTitleCounter=function(t,i,e){var o=this.activityControl[t].titlesExist[i];return void 0!==o?e&&o++:o=1,this.activityControl[t].titlesExist[i]=o,o},t.prototype.getGlobalActivityTitleCounter=function(t){var i=0;for(var e in this.activityControl)if(this.activityControl.hasOwnProperty(e)){var o=this.activityControl[e].titlesExist[t];i+=o||0}return i},t.prototype.getTitleByActivityExistance=function(t,i,e){var o="";if(this.existActivityTitle(t,e)){var r=this.getTitleClear(i.title),s=this.getGlobalActivityTitleCounter(r);o=this.getActivityTitleByRange(r,e,0,s)}else o=t;return o},t.prototype.getActivityTitleByRange=function(t,i,e,o){for(var r=e,s="",n=!0;r<=o&&n;)s=t,s+=r<=0?"":r,n=this.existActivityTitle(s,i),r++;return s+=n?r<=0?"":r:"",n?"":s},t}();CanvasService=__decorate([core_1.Injectable(),__param(0,core_1.Inject(flowService_1.FlowService)),__metadata("design:paramtypes",[flowService_1.FlowService,TCIServices_1.TCIServices])],CanvasService),exports.CanvasService=CanvasService;