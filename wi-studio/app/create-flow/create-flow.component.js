"use strict";var __decorate=this&&this.__decorate||function(e,t,i,o){var s,a=arguments.length,r=a<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(r=(a<3?s(r):a>3?s(t,i,r):s(t,i))||r);return a>3&&r&&Object.defineProperty(t,i,r),r},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}};Object.defineProperty(exports,"__esModule",{value:!0});var platform_browser_1=require("@angular/platform-browser"),contribution_observable_1=require("../../common/models/contribution_observable"),wi_contrib_service_1=require("../contrib/wi-contrib.service"),node_model_1=require("../../common/models/diagram/node.model"),task_model_1=require("../../common/models/app/task.model"),palette_service_1=require("../shared/services/palette.service"),flows_1=require("../../common/models/app/flows"),app_model_1=require("../../common/models/app/app.model"),flowService_1=require("../shared/services/flowService"),Observable_1=require("rxjs/Observable"),core_1=require("@angular/core"),router_1=require("@angular/router"),ng2_bootstrap_1=require("ng2-bootstrap"),connectionsService_1=require("../shared/services/connectionsService"),constants_1=require("../../common/constants"),lodash=require("lodash"),CREATE_FLOW={INVALID_PATH:"Resource Path already exists or is invalid.",NAME_REQUIRED:"Flow name is required."},CreateFlowComponent=function(){function e(e,t,i,o,s,a,r,n){var l=this;this._router=e,this._activatedRoute=t,this.connectionService=i,this.flowService=o,this.paletteService=s,this.contribService=a,this.sanitizer=r,this.appService=n,this.starters=[{type:"tibco-wi-timer",value:"Timer"},{type:"tibco-connection",value:"Connection"},{type:"tibco-wi-rest",value:"Rest Trigger"}],this.connections=[],this.flowNames=[],this.SUPPORTED_REST_VERBS=["GET","POST","PUT","DELETE"],this.next=!0,this.selectedMethods=[],this.valid=!1,this.settings=[],this._value="",this.businessObjectsExist=!1,this.errorMessage="",this.flowNameError="",this.flowName="",this.contributions=[],t.params.subscribe(function(e){l.appId=e.appId,l.sandboxId=e.sandboxId,l.flowService.getAppDetails(l.appId).subscribe(function(e){l.app=new app_model_1.AppModel(e);for(var t in l.app.flows){l.flowNames.push(l.app.flows[t].name);var i=l.app.flows[t].paths.root.is,o=l.app.flows[t].paths.nodes[i].taskID,s=l.app.flows[t].items[o];if("tibco-wi-rest"===s.name){var a={};a.flowName=l.app.flows[t].name;for(var r=0;r<s.handler.settings.length;r++)"method"===s.handler.settings[r].name.toLowerCase()?a.method=s.handler.settings[r].value:"path"===s.handler.settings[r].name.toLowerCase()&&(a.path=s.handler.settings[r].value);l.settings.push(a)}}})}),this._isSchemaError=!1,this._isPathError=!1}return e.prototype.moveNext=function(){this.next=!1},e.prototype.isDisabled=function(){return"tibco-wi-rest"!==this.selected?!this.name||!this.selected||this._hasError:!(this.selectedMethods.length>0&&this.path&&this.valid&&!this._hasError)},e.prototype.save=function(){var e=this;if(this.name&&this.selected){var t=1;this.paletteService.getSchemasFromServer().subscribe(function(i){e.contributions=i;for(var o in i)if(i[o].name===e.selected&&("General"===i[o].display.category||"Salesforce"===i[o].display.category)){if("tibco-wi-rest"===e.selected){t=e.selectedMethods.length;for(var s=0;s<t;s++)e.createFlow(i[o],s)}else e.createFlow(i[o]);break}})}},e.prototype.getUniqueName=function(e,t){for(;;){if(!(this.flowNames.indexOf(e)>-1))break;e+=t,t++}return e},e.prototype.createFlow=function(e,t){var i={};if("tibco-wi-rest"===this.selected){var o=this.sanitizer.sanitize(core_1.SecurityContext.HTML,this.getUniqueName(this.name+"_"+this.selectedMethods[t],1));i=new flows_1.Flow(o,this.sanitizer.sanitize(core_1.SecurityContext.HTML,this.description))}else i=new flows_1.Flow(this.sanitizer.sanitize(core_1.SecurityContext.HTML,this.name),this.sanitizer.sanitize(core_1.SecurityContext.HTML,this.description));if(this.app.addFlow(i),e=new task_model_1.FlowDiagramTask(e),e.taskType=constants_1.TASK_TYPE.TASK_ROOT,"tibco-wi-rest"===this.selected){for(s=0;s<e.handler.settings.length;s++)"method"===e.handler.settings[s].name.toLowerCase()?e.handler.settings[s].value=this.selectedMethods[t]:"path"===e.handler.settings[s].name.toLowerCase()&&(e.handler.settings[s].value=this.path);for(s=0;s<e.outputs.length;s++)if("body"===e.outputs[s].name.toLowerCase()){e.outputs[s].value={},e.outputs[s].value.value=this._value;break}}if("salesforce-trigger"===this.selected)for(var s=0;s<e.handler.settings.length;s++)if("connection name"===e.handler.settings[s].name.toLowerCase())e.handler.settings[s].value=this.connectionName;else if("connectionid"===e.handler.settings[s].name.toLowerCase())e.handler.settings[s].value=this.connectionId;else if("object name"===e.handler.settings[s].name.toLowerCase()){for(var a=0,r=this.businessObjects;a<r.length;a++){var n=r[a];e.handler.settings[s].allowed.push(n.name)}e.handler.settings[s].value=this.selectedTrigger}this.app.addActivityToFlow(i._id,lodash.cloneDeep(e));var l=new node_model_1.FlowDiagramNode;l.type=constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT,l.taskID=e.id,this.app.addNodeToFlow(i._id,l),this.app.setRoot(i._id,l.id),"tibco-wi-rest"===this.selected&&this.addReplyActivity(i._id,l.id),void 0!==t&&t!==this.selectedMethods.length-1||(this.app.isPushed=this.app.isPushed||!1,this.app.appChanges=1,this.triggerContribution())},e.prototype.addReplyActivity=function(e,t){var i;for(var o in this.contributions)if("tibco-wi-reply"===this.contributions[o].name&&"General"===this.contributions[o].display.category){i=new task_model_1.FlowDiagramTask(this.contributions[o]);break}i.taskType=constants_1.TASK_TYPE.TASK;for(var s=0;s<i.inputs.length;s++)if("data"===i.inputs[s].name.toLowerCase()){i.inputs[s].value={},i.inputs[s].value.value=this._value;break}this.app.addActivityToFlow(e,lodash.cloneDeep(i));var a=new node_model_1.FlowDiagramNode;a.type=constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE,a.taskID=i.id,a.parents.push(t),this.app.addNodeToFlow(e,a)},e.prototype.cancel=function(){this.flowModal.hide();var e={queryParams:{sandboxId:this.sandboxId,appId:this.appId}};this._router.navigate(["/applicationsdetail"],e)},e.prototype.ngAfterViewInit=function(){this.connectionsModal.config={ignoreBackdropClick:!0,keyboard:!1},this.flowModal.config={ignoreBackdropClick:!0,keyboard:!1},this.sfTriggerModal.config={ignoreBackdropClick:!0,keyboard:!1},this.flowModal.show()},e.prototype.triggerSelected=function(e){var t=this;if(!this.name||this.name&&""===this.name.trim()||null==this.name)return this._hasError=!0,this._errorMessage=CREATE_FLOW.NAME_REQUIRED,!1;this.selected=e,"tibco-connection"===e&&this.connectionService.getConnections().subscribe(function(e){for(var i=0,o=e;i<o.length;i++){var s=o[i];"salesforce"===s.category.toLowerCase()&&t.connections.push(s)}t.flowModal.hide(),t.connectionsModal.show()}),"tibco-wi-rest"===e&&(this.selected=e,this.moveNext()),"tibco-wi-timer"===e&&this.save()},e.prototype.connectionCancel=function(){this.connectionsModal.hide();var e={queryParams:{sandboxId:this.sandboxId,appId:this.appId}};this._router.navigate(["/applicationsdetail"],e)},e.prototype.triggerCancel=function(){this.sfTriggerModal.hide(),this.flowModal.hide();var e={queryParams:{sandboxId:this.sandboxId,appId:this.appId}};this._router.navigate(["/applicationsdetail"],e)},e.prototype.connectionSelected=function(e,t,i){var o=this;"MARKETO"===t&&this.sfTriggerModal.hide(),this.selected="salesforce-trigger",this.connectionName=i;var s={};this.paletteService.getSchemasFromServer().subscribe(function(t){for(var i in t)if(t[i].name===o.selected&&("Salesforce"===t[i].display.category||"Marketo"===t[i].display.category)){s=new task_model_1.FlowDiagramTask(t[i]);break}for(var a=0;a<s.handler.settings.length;a++)"object name"===s.handler.settings[a].name.toLowerCase()&&(o.sfTriggerSchemaURL=s.handler.settings[a].display.uri.split("{id}")[0]);o.connectionId=e,o.paletteService.getBuisinessObjects(o.sfTriggerSchemaURL,e).subscribe(function(e){o.businessObjects=e,o.businessObjectsExist=!0,o.selectedTrigger=o.businessObjects[0].name,o.connectionsModal.hide(),o.flowModal.hide(),o.sfTriggerModal.show()},function(e){o.errorMessage="There are no business objects for the selected connection",o.businessObjectsExist=!1}),o.selected="salesforce-trigger"})},e.prototype.onChange=function(e){this.flowName=e,this.flowNames.indexOf(e)>-1?(this._hasError=!0,this._errorMessage="This flow name is already used, Please use another name!!"):(this._hasError=!1,this._errorMessage="")},e.prototype.onPathChange=function(e){e&&(this._hasError=!1,this._errorMessage="",this.doValidation(),this.verifyPathStartSlash(e)?this.valid||(this._hasError=!0,this._errorMessage=CREATE_FLOW.INVALID_PATH):(this._hasError=!0,this._errorMessage='Title required and should start with "/" like "/pets/{id}" (not only "/{id}")'),this._isPathError=this._hasError)},e.prototype.toggleMethodSelection=function(e){this.selectedMethods.indexOf(e)>-1?this.selectedMethods.splice(this.selectedMethods.indexOf(e),1):this.selectedMethods.push(e),this.path&&this.onPathChange(this.path)},e.prototype.getClassName=function(e){return this.selectedMethods.indexOf(e)>-1?"method-active":""},e.prototype.doValidation=function(){var e;for(e=0;e<this.selectedMethods.length;e++){var t=void 0;for(t=0;t<this.settings.length;t++){this.settings[t].method,this.settings[t].path;if(this.settings[t].method===this.selectedMethods[e]&&!this.pathValidation(this.settings[t].path,this.path))break}if(t!==this.settings.length)break}e===this.selectedMethods.length?this.valid=!0:this.valid=!1},e.prototype.pathValidation=function(e,t){if(e&&t){var i=e.trim().split("/"),o=t.trim().split("/");if(""===i[i.length-1]&&i.splice(i.length-1,1),""===o[o.length-1]&&o.splice(o.length-1,1),i.length!==o.length)return!0;var s=void 0;for(s=0;s<i.length&&(i[s]!==i[s].replace(/.*\{|\}/gi,"")||o[s]!==o[s].replace(/.*\{|\}/gi,"")||!i[s]||!o[s]||i[s]===o[s]);s++);return s!==i.length}return!1},e.prototype.onValidate=function(e){e&&this.validateSchema(e)},e.prototype.getClassNameByConnectionType=function(e){return"SALESFORCE"===e&&(this.className="addConnection-bg-salesforce",this.connectionDisplayString="SF",this.colorByConnectionType="connectionType-SalesForce"),"MARKETO"===e&&(this.className="addConnection-bg-marketo",this.connectionDisplayString="M",this.colorByConnectionType="connectionType-Marketo"),this.className},e.prototype.triggerContribution=function(){var e=this,t=[],i=this;for(var o in this.app.flows)!function(e){if(e){var o=i.app.flows[e].paths.root.is,s=i.app.flows[e].paths.nodes[o].taskID,a=i.app.flows[e].items[s],r=a.handler.settings,n="General";a.display&&a.display.category&&(n=a.display.category),n+="/"+a.name,a.s3Prefix&&(n=a.s3Prefix+"/"+n);var l=i.contribService.getContributionService(n);if(l){var c;if(c=new task_model_1.FlowDiagramTask(lodash.cloneDeep(a)),c.changelist=["","Path"],c.appId=i.app.id,"Provider"===l.getType()){for(p=0;p<r.length;p++)!function(e){var i=l.getFieldProvider(r[e].name);i&&function(e){t.push(contribution_observable_1.ContributionObservable.eval(i,i.getFieldValue,null,c).map(function(t){null!==t&&("object"!=typeof t?"complex_object"===r[e].type?(r[e].value={},r[e].value.value=t):r[e].value=t:r[e].allowed=t)}))}(e);var o=l.getValidationProvider(r[e].name);o&&function(e){t.push(contribution_observable_1.ContributionObservable.eval(o,o.validate,null,c).map(function(t){null!==t&&(r[e].display||(r[e].display={}),r[e].display.readonly=t.isReadOnly(),r[e].display.valid=t.isValid(),r[e].display.visible=t.isVisible())}))}(e)}(p);var d=a.outputs;if(void 0!==d)for(p=0;p<d.length;p++)!function(e){var i=l.getFieldProvider(d[e].name);i&&function(e){t.push(contribution_observable_1.ContributionObservable.eval(i,i.getFieldValue,null,c).map(function(t){null!==t&&("object"!=typeof t?"complex_object"===d[e].type?(d[e].value={},d[e].value.value=t):d[e].value=t:d[e].allowed=t)}))}(e);var o=l.getValidationProvider(d[e].name);o&&function(e){t.push(contribution_observable_1.ContributionObservable.eval(o,o.validate,null,c).map(function(t){null!==t&&(d[e].display||(d[e].display={}),d[e].display.readonly=t.isReadOnly(),d[e].display.valid=t.isValid(),d[e].display.visible=t.isVisible())}))}(e)}(p)}else{for(p=0;p<r.length;p++)!function(e){!function(i){t.push(contribution_observable_1.ContributionObservable.eval(l,l.value,null,r[e].name,c).map(function(e){null!==e&&("object"!=typeof e?"complex_object"===r[i].type?(r[i].value={},r[i].value.value=e):r[i].value=e:r[i].allowed=e)}))}(e),function(i){t.push(contribution_observable_1.ContributionObservable.eval(l,l.validate,null,r[e].name,c).map(function(e){null!==e&&(r[i].display||(r[i].display={}),r[i].display.readonly=e.isReadOnly(),r[i].display.valid=e.isValid(),r[i].display.visible=e.isVisible())}))}(e)}(p);for(var h=a.outputs,p=0;p<h.length;p++)!function(e){!function(i){t.push(contribution_observable_1.ContributionObservable.eval(l,l.value,null,h[e].name,c).map(function(e){null!==e&&("object"!=typeof e?"complex_object"===h[i].type?(h[i].value={},h[i].value.value=e):h[i].value=e:h[i].allowed=e)}))}(e),function(i){t.push(contribution_observable_1.ContributionObservable.eval(l,l.validate,null,h[e].name,c).map(function(e){null!==e&&(h[i].display||(h[i].display={}),h[i].display.readonly=e.isReadOnly(),h[i].display.valid=e.isValid(),h[i].display.visible=e.isVisible())}))}(e)}(p)}}}}(o);Observable_1.Observable.merge.apply(Observable_1.Observable,t).toArray().subscribe(function(e){},function(e){},function(){var t={};t.app=e.app,e.flowService.postApp(t).subscribe(function(t){e.cancel()})})},e.prototype.verifyPathStartSlash=function(e){return/(?:^\/){1}(?:[-a-zA-Z0-9_])+(?:[\/]){0,1}(?:[-a-zA-Z0-9_\/\{\}\:])+$/i.test(e)},e.prototype.createFlowforConnectionTrigger=function(){this.selected&&(this.selected="salesforce-trigger",this.save())},e.prototype.setsfTriggerValue=function(e){this.selectedTrigger=e.target.value},e.prototype.validateSchema=function(e){if(e){this._errorMessage="",this._hasError=!1;var t=void 0;try{t=JSON.parse(e),t=JSON.stringify(t)}catch(e){this._errorMessage="Unexpected string in JSON",this._hasError=!0}}this._isSchemaError=this._hasError},e}();__decorate([core_1.ViewChild("connectionsModal"),__metadata("design:type",ng2_bootstrap_1.ModalDirective)],CreateFlowComponent.prototype,"connectionsModal",void 0),__decorate([core_1.ViewChild("flowModal"),__metadata("design:type",ng2_bootstrap_1.ModalDirective)],CreateFlowComponent.prototype,"flowModal",void 0),__decorate([core_1.ViewChild("sfTriggerModal"),__metadata("design:type",ng2_bootstrap_1.ModalDirective)],CreateFlowComponent.prototype,"sfTriggerModal",void 0),CreateFlowComponent=__decorate([core_1.Component({moduleId:module.id,selector:"create-flow",templateUrl:"create-flow.html",styleUrls:["less/create-flow.css"]}),__param(7,core_1.Inject("ApplicationService")),__metadata("design:paramtypes",[router_1.Router,router_1.ActivatedRoute,connectionsService_1.ConnectionsService,flowService_1.FlowService,palette_service_1.PaletteService,wi_contrib_service_1.ContribService,platform_browser_1.DomSanitizer,Object])],CreateFlowComponent),exports.CreateFlowComponent=CreateFlowComponent;