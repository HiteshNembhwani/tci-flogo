"use strict";var __decorate=this&&this.__decorate||function(e,t,n,o){var i,c=arguments.length,r=c<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,n,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(r=(c<3?i(r):c>3?i(t,n,r):i(t,n))||r);return c>3&&r&&Object.defineProperty(t,n,r),r},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),connectionsService_1=require("../shared/services/connectionsService"),salesforceoAuth_1=require("../shared/services/salesforceoAuth"),marketooAuth_1=require("../shared/services/marketooAuth"),windowRefService_1=require("../shared/services/windowRefService"),ng2_bootstrap_1=require("ng2-bootstrap"),router_1=require("@angular/router"),connectiontype_1=require("./connectiontype"),AddEditConnectionDetailsComponent=function(){function e(e,t,n,o,i,c){var r=this;if(this.connectionService=e,this.salesforceoAuthService=t,this.marketooAuthService=n,this._window=o,this._router=i,this._activatedRoute=c,this.connectionDetailsInputFields=[],this.loadingRedirectURL=!1,this.editMode=!1,this.connectionDescription="",this.connectionErrors="",this.connectionErrorDetail="",this.connectionNameType=[],this.errorUniqueConnectionName="",this.modalDialogClass="",this.baseLocationhRef="",this.baseLocationhRef=System.baseURL,this._window.nativeWindow.location.search.length>2&&this._window.nativeWindow.location.search.indexOf("state")>0){this.redirectQueryParam=this._window.nativeWindow.location.search.substring(this._window.nativeWindow.location.search.indexOf("code=")+5),this.loadingRedirectURL=!0;var s=this.redirectQueryParam.split("&state=")[0],a=this.redirectQueryParam.split("&state=")[1];a=decodeURIComponent(a),this.userName=a.split(",connectionUrl:")[0].split(",description:")[0].split("name:")[1],this.connectionDescription=a.split(",description:")[1].split(",category:")[0],this.connectionCategory=a.split(",category:")[1].split(",connectionUrl:")[0],this.connectionURL=a.split(",connectionUrl:")[1].split(",apiVersion")[0],this.api_version=a.split(",apiVersion:")[1].split("}")[0],this.userName=this.userName.replace(/[+%20]/g," "),this.connectionDescription=this.connectionDescription.replace(/[+%20]/g," "),this.connectionsData={name:this.userName,description:this.connectionDescription,category:this.connectionCategory,credential:{authType:"OAUTH2",auth_code:s,api_version:"v39.0"}};var d=this.baseLocationhRef+"wistudio/connections";this.salesforceoAuthService.postConnectionData(this.connectionURL,this.connectionsData).subscribe(function(e){e.json();r._window.nativeWindow.opener.location.href=d,r.loadingRedirectURL=!1,r._window.nativeWindow.close()},function(e){r.connectionErrors=JSON.parse(e.json().error.details)[0].message,r._window.nativeWindow.opener.location.href=d+"?error="+r.connectionErrors,r.loadingRedirectURL=!1,r._window.nativeWindow.close()})}}return e.prototype.ngOnInit=function(){var e=this;this._activatedRoute.queryParams.subscribe(function(t){e.connectionCategory=t.type,e.activeConnectionID=t.id,e.loginSavebuttonCaption="Login",e.connectionService.getConnectors().subscribe(function(t){e.newConnectionsObj=t;for(var n=0,o=e.newConnectionsObj;n<o.length;n++){var i=o[n];i.category===e.connectionCategory&&(e.addConnectionFields=i.settings)}for(var c,r=0,s=e.addConnectionFields;r<s.length;r++){var a=s[r];"authType"===a.name&&(c=a.value),"OAUTH2"===c&&("loginUrl"===a.name&&(e.connectionsConfigURL=a.wi.uri,e.oAuthURL=a.value),"instance"===a.name&&(e.postConnectionsURL=a.wi.uri)),a.wi.visible&&e.connectionDetailsInputFields.push(a)}}),void 0!==e.activeConnectionID&&e.connectionService.getConnectionsById(e.activeConnectionID).subscribe(function(t){e.userName=t.name,"undefined"!==t.description&&(e.connectionDescription=t.description),void 0!==t.credential&&(e.api_version=t.credential.api_version,e.identityURL=t.credential.token_endpoint,e.marketoClientId=t.credential.client_id,e.marketoClientSecret=t.credential.client_secret,e.endPointURL=t.credential.url),e.loginSavebuttonCaption="Save",e.editMode=!0})})},e.prototype.ngAfterViewInit=function(){void 0!==this.addEditConnectionDetail&&(this.addEditConnectionDetail.config={ignoreBackdropClick:!0,keyboard:!1}),this.loadingRedirectURL||this.addEditConnectionDetail.show()},e.prototype.modelChange=function(e,t){switch(e){case"Name":this.userName=t,this.errorUniqueConnectionName="";break;case"Description":this.connectionDescription=t;break;case"Identity URL":this.identityURL=t;break;case"Endpoint URL":this.endPointURL=t;break;case"Client ID":this.marketoClientId=t;break;case"Client Secret":this.marketoClientSecret=t;break;case"Api Version":this.api_version=t}},e.prototype.closeAddNewConnection=function(){this._router.navigate(["../wistudio/connections"]),this.addEditConnectionDetail.hide()},e.prototype.loginToOAuth=function(e){var t=this,n={};this.connectionService.getConnections().subscribe(function(o){for(var i=0,c=n=o;i<c.length;i++){var r=c[i];if(r.category.toLowerCase()===e.toLocaleLowerCase()&&r.name.toLowerCase()===t.userName.toLocaleLowerCase()){if(!t.editMode)return void(t.errorUniqueConnectionName="This Connection name already exist. Please choose a different name");if(t.activeConnectionID!==r.id)return void(t.errorUniqueConnectionName="This Connection name already exist. Please choose a different name")}}t.errorUniqueConnectionName="","MARKETO"===e&&t.marketooAuthFlow(),"SALESFORCE"===e&&t.salesforceoAuthFlow()},function(e){t.errorUniqueConnectionName="Error validating unique connection names."})},e.prototype.salesforceoAuthFlow=function(){var e,t=this;if(e="{name:"+this.userName+",description:"+this.connectionDescription+",category:"+this.connectionCategory+",connectionUrl:"+this.postConnectionsURL+",apiVersion:"+this.api_version+"}",this.editMode){var n={name:this.userName,description:this.connectionDescription,category:this.connectionCategory,credential:{authType:"OAUTH2",api_version:"v39.0"}};this.salesforceoAuthService.updateConnectionData(n,this.activeConnectionID).subscribe(function(e){e.json();t.addEditConnectionDetail.hide();t._router.navigate(["../wistudio/connections"])},function(e){var n=JSON.parse(e.json().error.details)[0].message;t._router.navigate(["../wistudio/connections"],{queryParams:{error:n}}),t.addEditConnectionDetail.hide()})}this.editMode||this.salesforceoAuthService.getClientID(this.connectionsConfigURL,this.oAuthURL).subscribe(function(n){var o=n.json();t.oAuthURL=t.oAuthURL+"&client_id="+o.clientId+"&redirect_uri="+o.callbackUrl+"&display=popup&prompt=login consent&state=",t.oAuthURL=encodeURI(t.oAuthURL)+encodeURI(e),t._popUpWindow=t._window.nativeWindow.open(t.oAuthURL,"salesforceoAuth_Window","height=600,width=600,top=100px,left=300px")})},e.prototype.marketooAuthFlow=function(){var e=this,t={name:this.userName,description:this.connectionDescription,category:this.connectionCategory,credential:{authType:"OAUTH2_TWOLEG",url:this.endPointURL||"",client_id:this.marketoClientId||"",client_secret:this.marketoClientSecret||"",token_endpoint:this.identityURL||""}};this.editMode&&this.marketooAuthService.updateConnectionData(t,this.activeConnectionID).subscribe(function(t){t.json();e.addEditConnectionDetail.hide(),e._router.navigate(["../wistudio/connections"])},function(t){e._router.navigate(["../wistudio/connections"],{queryParams:{error:t.json().error.message}}),e.addEditConnectionDetail.hide()}),this.editMode||this.marketooAuthService.postConnectionData(this.connectionsConfigURL,t).subscribe(function(t){t.json();e.addEditConnectionDetail.hide(),e._router.navigate(["../wistudio/connections"])},function(t){e._router.navigate(["../wistudio/connections"],{queryParams:{error:t.json().error.message}}),e.addEditConnectionDetail.hide()})},e.prototype.getClassNameByConnectionType=function(e){return e===connectiontype_1.ConnectionType.SALESFORCE&&(this.className="addConnection-bg-salesforce",this.connectionDisplayString="SF",this.colorByConnectionType="connectionType-SalesForce",this.connectorTitle="Salesforce",this.modalDialogClass=""),e===connectiontype_1.ConnectionType.MARKETO&&(this.className="addConnection-bg-marketo",this.connectionDisplayString="M",this.colorByConnectionType="connectionType-Marketo",this.connectorTitle="Marketo",this.modalDialogClass="addConnections-Modal-Dialog-Marketo"),this.className},e.prototype.isInputTypeText=function(e){if("text"===e)return!0},e.prototype.isInputTypeList=function(e){if("list"===e)return!0},e.prototype.getInputValueFromConnections=function(e){var t;switch(e){case"Name":t=this.userName;break;case"Description":t=this.connectionDescription;break;case"Api Version":t=this.api_version;break;case"Identity URL":t=this.identityURL;break;case"Client ID":t=this.marketoClientId;break;case"Client Secret":t=this.marketoClientSecret;break;case"Endpoint URL":t=this.endPointURL}return t},e.prototype.isOptional=function(e){return e?"addconnections-font-semibold":""},e.prototype.getConnectorIconSrc=function(e){var t="";return"salesforce"===e.toLowerCase()&&(t="wistudio/v1/contributions/connectors/tibco-salesforce/icons/ic-tibco-salesforce.svg"),"marketo"===e.toLowerCase()&&(t="wistudio/v1/contributions/connectors/tibco-marketo/icons/ic-tibco-marketo.svg"),this.baseLocationhRef+t},e}();__decorate([core_1.Input(),__metadata("design:type",Object)],AddEditConnectionDetailsComponent.prototype,"connectorObj",void 0),__decorate([core_1.ViewChild("addEditConnectionDetail"),__metadata("design:type",ng2_bootstrap_1.ModalDirective)],AddEditConnectionDetailsComponent.prototype,"addEditConnectionDetail",void 0),AddEditConnectionDetailsComponent=__decorate([core_1.Component({moduleId:module.id,selector:"add-edit-connectiondetails",templateUrl:"connections.addEdit-connectionDetails.html",styleUrls:["connections.add-connection.css"]}),__metadata("design:paramtypes",[connectionsService_1.ConnectionsService,salesforceoAuth_1.SalesforceoAuthService,marketooAuth_1.MarketooAuthService,windowRefService_1.WindowRef,router_1.Router,router_1.ActivatedRoute])],AddEditConnectionDetailsComponent),exports.AddEditConnectionDetailsComponent=AddEditConnectionDetailsComponent;