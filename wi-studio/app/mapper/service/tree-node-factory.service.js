"use strict";var __decorate=this&&this.__decorate||function(e,t,r,n){var a,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var i=e.length-1;i>=0;i--)(a=e[i])&&(s=(o<3?a(s):o>3?a(t,r,s):a(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),lodash=require("lodash"),TreeNodeFactoryService=function(){function e(){}return e.prototype.fromJsonSchema=function(e,t){return e?this.makeTreeNodes(e,t,{level:0,path:null}):[]},e.prototype.applyArrayFilterToJsonSchema=function(e,t,r,n){var a=this;if(void 0===n&&(n=!1),t=t||[],!e||e!==Object(e))return{};var o,s=Object.assign({},e);if("object"===e.type)o=s.properties;else{if("array"!==e.type)return s;var i=t?t[0]:null;if(i&&i.params[0]!==r)return null;t=t.slice(1),o=this.isObject(s.items)?s.items.properties:null}if(this.isObject(o)){s.properties=Object.keys(o).map(function(e){var s=(r?r+".":"")+e,i=a.applyArrayFilterToJsonSchema(o[e],t,s,n);return i?[e,i]:null}).filter(function(e){if(!e)return!1;e[0];return!0}).reduce(function(e,t){var r=t[0],n=t[1];return e[r]=n,e})}return s},e.prototype.fromFunctions=function(e){if(e!==Object(e))return[];var t=new Map,r=function(e,r){var n=t.get(e);n||(n={label:e,children:[],styleClass:"node--has-children"},t.set(e,n)),n.children.push(r)},n=[];Object.keys(e).forEach(function(t){var a=e[t],o=a.category.split("/"),s=a.name;o.pop();var i=o.join("/"),c=a.function.help,p=s+"("+a.function.args.reduce(function(e,t){return/\.\.\.(.+)/g.test(t.type)?e.push(t.name+"1",t.name+"2"):e.push(t.name),e},[]).join(", ")+")",l={label:p,isSelectable:!0,styleClass:"node--selectable node--has-no-children",data:{help:c,snippet:o.concat(p).join(".")}};i?r(i,l):n.push(l)});var a=function(e){return lodash.sortBy(e,"label")},o=n.concat(Array.from(t.values())).map(function(e){return e.children?e.children=a(e.children):e.isSelectable=!0,e});return a(o)},e.prototype.fromJsonSchemaToSymbolTable=function(e,t){var r=this;void 0===t&&(t=0);var n={};return"object"===e.type?n=e.properties:"array"===e.type&&e.items&&e.items.properties&&(n=e.items.properties),n!==Object(n)?[]:Object.keys(n).reduce(function(e,a){var o=n[a],s={name:a,type:o.type};return"object"!==o.type&&"array"!==o.type||(s.children=r.fromJsonSchemaToSymbolTable(o)),"object"===o.type&&0===t&&(o.type="namespace"),e[a]=s,e},{})},e.prototype.fromFunctionsToSymbolTable=function(e){if(e!==Object(e))return{};var t=new Map,r=function(e,r){var n=t.get(e);n||(n={name:e,type:"namespace",children:[]},t.set(e,n)),n.children.push(r)},n=[];return Object.keys(e).forEach(function(t){var a=e[t],o=a.category.split("/"),s=a.name;o.pop();var i=o.join("/"),c=Object.assign({},a.function,{name:s,type:"function"});i?r(i,c):n.push(c)}),Array.from(t.values()).reduce(function(e,t){return e[t.name]=t,e},{})},e.prototype.makeTreeNodes=function(e,t,r){var n,a=this,o={},s=r.level,i=r.path,c=s+1;return"object"===e.type?(o=e.properties,n=e.required||[]):"array"===e.type&&e.items&&(n=e.items.required||[],e.items.properties&&(o=e.items.properties)),o!==Object(o)?[]:Object.keys(o).map(function(e){var r=o[e],s=(i?i+".":"")+e,p=r.type;"string"!==p||"date"!==r.format&&"date-time"!==r.format||(p="date");var l={label:e,isSelectable:!0,styleClass:"mapper-tree__node",path:s,snippet:s,dataType:p,data:{}};if("object"===r.type||"array"===r.type){l.children=a.makeTreeNodes(r,t,{path:s,level:c});var u=lodash.get(r,"items.properties",null),y=lodash.get(r,"items.type",null);!u&&"array"===r.type&&y&&(l.memberType=r.items.type);var f=l.children&&l.children.length;l.isSelectable=!0,l.styleClass=l.styleClass+" "+(f?"node--has-children":"node--has-no-children")}else l.styleClass=l.styleClass+" node--has-no-children";return t&&(l=t(l,c,s)),l.isSelectable&&(l.styleClass=l.styleClass+" node--selectable"),n&&n.length&&n.indexOf(e)>=0&&(l.styleClass=l.styleClass+" node--required"),l})},e.prototype.linkCurrentContextToParent=function(e,t){for(var r in t)t.hasOwnProperty(r)&&(t[r.replace(/\$/gi,e)]=t[r],delete t[r])},e.prototype.traverseMappings=function(e,t){void 0===t&&(t={});for(var r in e)if(e.hasOwnProperty(r)){var n=e[r];n.expression&&(t[r]=n.expression),n.mappings&&(this.linkCurrentContextToParent(r,n.mappings),this.traverseMappings(n.mappings||{},t))}return t},e.prototype.flatMappings=function(e){return this.traverseMappings(lodash.cloneDeep(e))},e.prototype.isObject=function(e){return e&&e===Object(e)},e}();TreeNodeFactoryService=__decorate([core_1.Injectable()],TreeNodeFactoryService),exports.TreeNodeFactoryService=TreeNodeFactoryService;