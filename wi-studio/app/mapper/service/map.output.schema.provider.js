"use strict";var __decorate=this&&this.__decorate||function(e,t,r,o){var a,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var p=e.length-1;p>=0;p--)(a=e[p])&&(s=(i<3?a(s):i>3?a(t,r,s):a(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),schema=require("generate-schema"),lodash=require("lodash"),constants_1=require("../../../common/constants"),contributionHelper_1=require("../../../common/util/contributionHelper"),ScopedOutputSchemaProvider=function(){function e(){}return e.prototype.getSchema=function(e){return this.outputSchema={type:"object",title:"Outputs",properties:{}},this.app=e.app,this.flow=e.flow,this.node=e.node,this.traverseParentNodes(this.node),this.outputSchema},e.prototype.traverseParentNodes=function(e){for(var t=0;t<e.parents.length;t++){var r=this.flow.paths.nodes[e.parents[t]];if(!r)for(var o in this.flow.errorHandler)if(r=this.flow.errorHandler[o].paths.nodes[e.parents[t]])break;var a=r.taskID;if(a){this.task=this.getParentItem(a);var i={type:"object",title:this.task.title,properties:{}};i.properties=this.getOutputsSchema(),lodash.isEmpty(i.properties)||(this.task.taskType===constants_1.TASK_TYPE.TASK_ROOT?"tibco-wi-error"===this.task.name?this.outputSchema.properties.$Error=i:this.outputSchema.properties.$TriggerData=i:this.outputSchema.properties["$"+this.task.title]=i),this.traverseParentNodes(r)}}},e.prototype.getParentItem=function(e){var t=this.flow.items[e];if(!t)for(var r in this.flow.errorHandler)if(t=this.flow.errorHandler[r].items[e])break;return t},e.prototype.getOutputsSchema=function(){var e={},t=this.task.outputs;if(t)for(var r=0,o=t;r<o.length;r++){var a=o[r];if(!a.display||!1!==a.display.visible)if("string"===a.type||"number"===a.type||"boolean"===a.type){var i={type:"",required:!1};i.type=a.type,e[a.name]=i}else if("complex_object"===a.type)if("texteditor"===a.display.type){if(a.value&&a.value.value)if(this.isJson(a.value.value))try{e[a.name]=schema.json(JSON.parse(a.value.value))}catch(e){}else try{e[a.name]=JSON.parse(a.value.value)}catch(e){}}else if("params"===a.display.type.toLowerCase()&&a.value&&a.value.value)try{var s=JSON.parse(a.value.value);e[a.name]=JSON.parse(contributionHelper_1.ContributionHelper.jsonToSchema(s))}catch(e){}}return e},e.prototype.isJson=function(e){try{e=JSON.parse(e)}catch(t){e={}}return!e.type||!e.properties&&!e.items},e}();ScopedOutputSchemaProvider=__decorate([core_1.Injectable()],ScopedOutputSchemaProvider),exports.ScopedOutputSchemaProvider=ScopedOutputSchemaProvider;