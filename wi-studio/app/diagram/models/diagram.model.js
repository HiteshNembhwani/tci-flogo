"use strict";function _insertChildNodes(e,t,o){var a=e.length-1;return o.children.length&&(o.children.sort(function(e,o){return t.nodes[e].type===t.nodes[o].type?0:t.nodes[e].type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH||t.nodes[e].type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_LINK?1:-1}),lodash.each(o.children,function(s){if(t.nodes[s].type!==constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH)e[a].push(s);else{var n=Array(e[a].indexOf(o.id));n.push(s),e.push(n)}t.nodes[s].type!==constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_LINK&&_insertChildNodes(e,t,t.nodes[s])})),e}function _triggerCustomEvent(e,t,o){if(CustomEvent&&o.dispatchEvent){if(e){var a={view:window,bubbles:!0,cancelable:!0,cancelBubble:!0,detail:t};try{o.dispatchEvent(new CustomEvent(e,a))}catch(e){}return!0}return constants_2.FLOW_DIAGRAM_DEBUG,!1}return constants_2.FLOW_DIAGRAM_DEBUG,!1}function _getTaskStatus(e){return{}}function _isNodeHasDetails(e){return!!e.type&&-1===[constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ADD,constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT_NEW,constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_HOLDER].indexOf(e.type)}function _isNodeHasMenu(e){return!!e.type&&-1===[constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ADD,constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT_NEW,constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_HOLDER,constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT_ERROR_NEW].indexOf(e.type)}function _isNodeSelectable(e){return!!e.type&&-1===[constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_HOLDER,constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_PADDING].indexOf(e.type)}function _isTaskHasMapping(e){return e&&lodash.isArray(e.inputMappings)&&e.inputMappings.length>0}function _getRowHeight(e,t){return e.querySelector("."+t).getBoundingClientRect().height}function _isInSingleRow(e){return 1===e.parents.length&&e.children.length<2}function _isBranchNode(e){return e.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH}function _hasTaskRun(e,t){if(!e||!t)return!1;var o=t[e.taskID];return!!o&&lodash.get(o,"__status.hasRun",!1)}function _hasBranchRun(e,t,o){if(!(e&&t&&o&&_isBranchNode(e)))return!1;var a=lodash.get(e,"parents",[]),s=lodash.get(e,"children",[]);return!(!a.length||!s.length)&&(lodash.some(a,function(e){return _hasTaskRun(o[e],t)})&&lodash.some(s,function(e){return _hasTaskRun(o[e],t)}))}function _removeNodeInSingleRow(e,t){var o=t[e.parents[0]],a=t[e.children[0]];a?a.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH?(_removeBranchNode(a,t),o.children.splice(o.children.indexOf(e.id),1)):(a.parents.splice(a.parents.indexOf(e.id),1,o.id),o.children.splice(o.children.indexOf(e.id),1,a.id)):o.children.splice(o.children.indexOf(e.id),1),delete t[e.id]}function _removeNodeHasChildren(e,t){e.children.length>1&&(e.children=lodash.filter(lodash.clone(e.children),function(e){var o=t[e];return!o||o.type!==constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH||(_deleteNode(o,t),!1)})),_deleteNode(e,t)}function _removeBranchNode(e,t){e.children.length>0&&_recursivelyDeleteNodes(t[e.children[0]],t),_removeNodeInSingleRow(e,t)}function _deleteNode(e,t){e&&t&&(e.children.length>1?_removeNodeHasChildren(e,t):e.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH?_removeBranchNode(e,t):_isInSingleRow(e)?_removeNodeInSingleRow(e,t):constants_2.FLOW_DIAGRAM_DEBUG)}function _recursivelyDeleteNodes(e,t){e.children.length>0&&lodash.each(lodash.clone(e.children),function(e){var o=t[e];o&&_recursivelyDeleteNodes(o,t)}),_deleteNode(e,t)}Object.defineProperty(exports,"__esModule",{value:!0});var node_model_1=require("../../../common/models/diagram/node.model"),constants_1=require("../../../common/constants"),constants_2=require("../../../common/constants"),utils_1=require("../tools/utils"),iconTools=require("../../shared/directives/taskicon/tools"),d3=require("d3"),lodash=require("lodash"),DEFAULT_MAX_ROW_LEN=6,MAX_ROW_LEN;exports.CLS={diagram:"flogo-flows-detail-diagram",diagramRow:"flogo-flows-detail-diagram-row",diagramRowStatusSelected:"flogo-flows-detail-diagram-row-selected",diagramNode:"flogo-flows-detail-diagram-node",diagramNodeBranchHover:"flogo-flows-diagram-node-branch-hover",diagramNodeStatusSelected:"flogo-flows-detail-diagram-node-selected",diagramNodeStatusRun:"flogo-flows-detail-diagram-node-run",diagramNodeStatusHasError:"flogo-flows-detail-diagram-node-has-error",diagramNodeStatusHasWarn:"flogo-flows-detail-diagram-node-has-warn",diagramNodeDetail:"flogo-flows-detail-diagram-node-detail",diagramNodeDetailBranch:"flogo-flows-detail-diagram-node-detail-branch",diagramNodeDetailBranchSelected:"flogo-flows-detail-diagram-node-detail-branch-selected",diagramNodeDetailBranchHover:"flogo-flows-detail-diagram-node-detail-branch-hover",diagramNodeDetailBranchRun:"flogo-flows-detail-diagram-node-detail-branch-run",diagramNodeDetailIcon:"flogo-flows-detail-diagram-node-detail-icon",diagramNodeDetailTitle:"flogo-flows-detail-diagram-node-detail-title",diagramNodeDetailTitleHelper:"titleHelper",diagramNodeDetailDesc:"flogo-flows-detail-diagram-node-detail-description",diagramNodeBadge:"flogo-flows-detail-diagram-node-badge",diagramNodeMenu:"flogo-flows-detail-diagram-node-menu",diagramNodeMenuBox:"flogo-flows-detail-diagram-node-menu-box",diagramNodeMenuList:"flogo-flows-detail-diagram-node-menu-list",diagramNodeMenuGear:"flogo-flows-detail-diagram-node-menu-gear",diagramDraggablePoint:"flow-detail-diagram-node-draggable",diagramNodeHasValue:"flow-node-branch-has-value",diagramStatusIcon:"flogo-flows-detail-diagram-status-icon",diagramIcError:"flogo-flows-detail-diagram-ic-error",diagramStatusIconHidden:"diagram-status-icon-hidden",wistudioRow:"wistudio-row",wistudioTileError:"wistudio-tile-error",wistudioTileNodeError:"wistudio-tile-node-error",wistudioRowLastTile:"wistudio-row-last-tile",wistudioTileRowHover:"wistudio-row-hover",wistudioAddTileDroppable:"wistudio-add-tile-droppable"},exports.DATA_ATTR={dataTaskId:"data-task-id",dataNodeId:"data-node-id",dataMenuItemType:"data-menu-item-type",dataFlogoNodeType:"data-flogo-node-type"};var FlowDiagram=function(){function e(e,t,o,a,s){this.diagram=e,this.tasks=t,this.elm=o,this.diagramType=a,this.serviceErrors=s,this.maxRowLenght=DEFAULT_MAX_ROW_LEN,this.ng2StyleAttr="",this.updateDiagram(e),this.render()}return e.prototype.setDiagramType=function(e){this.diagramType=e},e.isBranchNode=function(e){return _isBranchNode(e)},e.hasBranchRun=function(e,t,o){return _hasBranchRun(e,t,o)},e.transformDiagram=function(e){var t,o=[];return e&&e.root&&e.root.is&&(t=e.nodes[e.root.is]),t?(o.push([t.id]),_insertChildNodes(o,e,t),o):o},e.padMatrix=function(e,t,o){void 0===t&&(t=MAX_ROW_LEN);var a=[];return lodash.each(e,function(e){if(e.length<t){var s=void 0;s=1===e.length&&o.nodes[e[0]].type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT_NEW?e:e.concat("+");var n=t-s.length,r=lodash.fill(Array(n),"+");a.push(s.concat(r))}else a.push(e)}),a},e.getEmptyDiagram=function(e){var t=new node_model_1.FlowDiagramNode,o={root:{is:t.id},nodes:{}};return t.type="error"===e?constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT_ERROR_NEW:constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT_NEW,o.nodes[t.id]=t,o},e.filterOverflowAddNode=function(e,t,o){void 0===o&&(o=MAX_ROW_LEN);var a=lodash.cloneDeep(e);return lodash.each(a,function(e){if(e.length>o)for(var a=e.length-o,s=void 0;a;)!(s=t[e[e.length-1]])||s.type!==constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ADD&&s.type!==constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT_NEW||e.pop(),a--}),a},e.prototype.calculateMaxCountTiles=function(t){var o=[];e.transformDiagram(t).map(function(e){e.map(function(e,t){o.push(t)})});var a=lodash.max(o)+2,s=d3.select(this.elm).append("div").classed(exports.CLS.diagram,!0).html('<div class="'+exports.CLS.diagramRow+'"><div class="'+exports.CLS.diagramNode+'" '+exports.DATA_ATTR.dataFlogoNodeType+'="node_add"><div class="'+exports.CLS.diagramNodeDetail+'"></div></div></div>'),n=s.select("."+exports.CLS.diagramNode).node(),r=n.getBoundingClientRect().width+2*+window.getComputedStyle(n).marginLeft.replace("px",""),i=this.elm.parentElement.getBoundingClientRect().width-+window.getComputedStyle(d3.select("."+exports.CLS.diagramRow).node()).paddingLeft.replace("px",""),d=i>0&&r>0?Math.floor(i/r):1;s.remove(),this.maxRowLenght=lodash.max([DEFAULT_MAX_ROW_LEN,d,a])},e.prototype.update=function(e){var t=this,o=[];return e.diagram&&o.push(this.updateDiagram(e.diagram)),e.tasks&&o.push(this.updateTasks(e.tasks)),e.element&&o.push(this.updateElement(e.element)),Promise.all(o).then(function(){return t})},e.prototype.updateAndRender=function(e){var t=this;return this.update(e).then(function(){return t.render()})},e.prototype.updateDiagram=function(t){if(this.calculateMaxCountTiles(t),lodash.isEmpty(t)||lodash.isEmpty(t.root))this.updateDiagram(e.getEmptyDiagram(this.diagramType));else{this.root=lodash.cloneDeep(t.root);var o={};lodash.forIn(t.nodes,function(e,t){e instanceof node_model_1.FlowDiagramNode?o[t]=e:o[t]=new node_model_1.FlowDiagramNode(e)}),this.nodes=o,this.maxRowLenght=lodash.isNumber(t.MAX_ROW_LEN)?t.MAX_ROW_LEN:this.maxRowLenght}return Promise.resolve(this)},e.prototype.updateTasks=function(e){return this.tasks=e,Promise.resolve(this)},e.prototype.updateElement=function(e){return d3.select(this.elm).select("."+exports.CLS.diagram).selectAll("."+exports.CLS.diagramRow).remove(),this.elm=e,Promise.resolve(this)},e.prototype.exitNodes=function(){d3.selectAll("."+exports.CLS.diagramNodeStatusSelected).classed(exports.CLS.diagramNodeStatusSelected,function(e){return lodash.set(e,"__status.isSelected",!1),!1})},e.prototype._bindDataToRows=function(t){return t.data(e.filterOverflowAddNode(e.padMatrix(e.transformDiagram(this),this.maxRowLenght,this),this.nodes))},e.prototype._handleEnterRows=function(e){e.enter().append("div").attr(this.ng2StyleAttr,"").classed(exports.CLS.diagramRow,!0).classed(exports.CLS.wistudioRow,!0).style("z-index",function(t,o){return e.size()-o})},e.prototype._handleUpdateRows=function(e){e.classed("updated",!0);var t=this._bindDataToNodes(e);this._handleTaskNodes(t,e)},e.prototype._handleExitRows=function(e){e.exit().classed({updated:!1,exit:!0}).on("mouseenter",null).on("mouseleave",null).remove()},e.prototype._bindDataToNodes=function(e){var t=this,o=[];return e.selectAll("."+exports.CLS.diagramNode).data(function(e,a){return lodash.map(e,function(e,a){var s=t.nodes[e];return"+"===e?((s=new node_model_1.FlowDiagramNode).linkToParents([lodash.last(o)]),t.nodesOfAddType[s.id]=s):"_"===e||lodash.isEmpty(s)&&(s=new node_model_1.FlowDiagramNode({id:"",taskID:"",type:constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_PADDING,children:[],parents:[],subProc:[]})),o.push(s.id),s})})},e.prototype._handleEnterNodes=function(e,t){var o=this,a=this,s=[constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ADD,constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_HOLDER,constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT_NEW,constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_PADDING,constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT_ERROR_NEW];e.enter().append("div").attr(exports.DATA_ATTR.dataTaskId,function(e){return e.taskID||-1}).attr(exports.DATA_ATTR.dataNodeId,function(e){return e.id||-1}).attr(this.ng2StyleAttr,"").classed(exports.CLS.diagramNode,!0).classed(exports.CLS.wistudioTileError,function(e){return o.serviceErrors.tasks[e.taskID]}).classed(exports.CLS.wistudioTileNodeError,function(e){return o.serviceErrors.nodes[e.id]}).on("click",function(e,t,o,a){if(_isNodeSelectable(e)){d3.event;var s="";e.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ADD||e.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT_NEW?s="flogoAddTask":-1!==[constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE,constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT,constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH,constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT_ERROR_NEW].indexOf(e.type)&&(s="flogoSelectTask"),s&&_triggerCustomEvent(s,{origEvent:d3.event,node:e,col:t,row:o},this),d3.selectAll("."+exports.CLS.diagramNodeStatusSelected).classed(exports.CLS.diagramNodeStatusSelected,function(e){return lodash.set(e,"__status.isSelected",!1),!1}),d3.selectAll("."+exports.CLS.diagramRowStatusSelected).classed(exports.CLS.diagramRowStatusSelected,!1),d3.select(this).classed(exports.CLS.diagramNodeStatusSelected,function(e){return lodash.set(e,"__status.isSelected",!0),!0}),e.type!==constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH&&d3.select(this.parentElement).classed(exports.CLS.diagramRowStatusSelected,!0)}}).on("mouseenter",function(e){var o=this;if(a.rowHoverArtifactsShow(o),-1===s.indexOf(e.type)&&e.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH){var n=!1;d3.select(a.elm).selectAll("."+exports.CLS.diagramRow).each(function(o,a){n||-1===o.indexOf(e.id)||(d3.select(this).classed(exports.CLS.diagramNodeBranchHover,!0).style("z-index",function(){return t.size()+1}),n=!0)})}}).on("mouseleave",function(e){var o=this;if(a.rowHoverArtifactsHide(o),e.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH&&d3.selectAll("."+exports.CLS.diagramNodeBranchHover).classed(exports.CLS.diagramNodeBranchHover,!1),e.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH){var s=!1;d3.select(a.elm).selectAll("."+exports.CLS.diagramRow).each(function(o,a){s||-1===o.indexOf(e.id)||(d3.select(this).style("z-index",function(){return t.size()-a}),s=!0)})}})},e.prototype.rowHoverArtifactsShow=function(e){for(var t=e.parentElement.getElementsByClassName(exports.CLS.diagramNode),o=0;o<t.length;o++)t[o].classList.add(exports.CLS.wistudioTileRowHover)},e.prototype.rowHoverArtifactsHide=function(e){for(var t=e.parentElement.getElementsByClassName(exports.CLS.diagramNode),o=0;o<t.length;o++)t[o].classList.remove(exports.CLS.wistudioTileRowHover)},e.prototype._handleUpdateNodes=function(e,t){var o=this,a=[];e.each(function(e,t,o){e.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE&&(a[o]=e.taskID)}).attr(exports.DATA_ATTR.dataFlogoNodeType,function(e){return constants_1.FLOW_DIAGRAM_NODE_TYPE[e.type].toLowerCase()}).each(function(e,t,s){d3.select(this).classed(exports.CLS.wistudioTileError,function(e){return o.serviceErrors.tasks[e.taskID]}).classed(exports.CLS.wistudioTileNodeError,function(e){return o.serviceErrors.nodes[e.id]}).classed(exports.CLS.wistudioRowLastTile,a[s]===e.taskID).attr(exports.DATA_ATTR.dataTaskId,function(e){return e.taskID||-1}).attr(exports.DATA_ATTR.dataNodeId,e.id)}),lodash.some(d3.selectAll("."+exports.CLS.diagramNodeStatusSelected).data(),function(e){return e&&(e.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE||e.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT)})||d3.select("."+exports.CLS.diagramRowStatusSelected).classed(exports.CLS.diagramRowStatusSelected,!1);var s=this._bindDataToNodeMenus(e.selectAll("."+exports.CLS.diagramNodeMenu));this._handleNodeMenus(s);var n=this._bindDataToNodeDetails(t);this._handleNodeDetails(n,t);var r=this._bindDataToNodeBadges(e.selectAll("."+exports.CLS.diagramNodeBadge));this._handleNodeBadges(r)},e.prototype._handleExitNodes=function(e,t){e.exit().on("click",null).on("mouseover",null).on("mouseleave",null).on("flogoClickNodeMenu",null).remove()},e.prototype._handleTaskNodes=function(e,t){this._handleEnterNodes(e,t),this._handleUpdateNodes(e,t),this._handleExitNodes(e,t)},e.prototype._bindDataToNodeDetails=function(e){var t=this;return e.selectAll("."+exports.CLS.diagramNode).selectAll("."+exports.CLS.diagramNodeDetail).data(function(e){if(e){var o=t.tasks[e.taskID];if(o&&_isNodeHasDetails(e)){var a=void 0,s=_getTaskStatus(o);return a=o.name||"",[{name:o.name,title:o.title||o.name,desc:a,type:o.type,taskStatus:s,nodeInfo:e,schema:o}]}}return[{nodeInfo:e}]})},e.prototype._handleEnterNodeDetails=function(e,t){e.enter().append("div").attr(this.ng2StyleAttr,"").classed(exports.CLS.diagramNodeDetail,!0).classed(exports.CLS.diagramDraggablePoint,!0)},e.prototype._handleUpdateNodeDetails=function(e,t){var o=this,a=_getRowHeight(o.elm,exports.CLS.diagramRow);t.selectAll("."+exports.CLS.diagramNodeDetail).html(function(e,s,n){if(lodash.isEmpty(e))return"";if(e.nodeInfo.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH){var r=n,i=0,d={id:e.nodeInfo.parents[0]};t.each(function(e,t){if(!i){var o=e.indexOf(d.id);-1!==o&&(d.loc={col:o,row:t},i=r-t)}});var l=a*i-5,c=utils_1.genBranchLine({svgHeight:l});return lodash.map([{class:exports.CLS.diagramNodeDetailBranch,state:"default"},{class:exports.CLS.diagramNodeDetailBranchHover,state:"hover"},{class:exports.CLS.diagramNodeDetailBranchSelected,state:"selected"},{class:exports.CLS.diagramNodeDetailBranchRun,state:"run"}],function(e){var t=btoa(c[e.state].trim().replace(/"/g,"'").replace(/\s+/g," "));return"\n              <div "+o.ng2StyleAttr+' class="'+e.class+'">\n                <div '+o.ng2StyleAttr+' class="img-left" style="background:url(data:image/svg+xml;base64,'+t+") left bottom no-repeat; height: "+l+'px"></div>\n                <div '+o.ng2StyleAttr+' class="img-right" style="background:url(data:image/svg+xml;base64,'+t+') right bottom no-repeat;"></div>\n              </div>\n            '}).join("")}if(e.name&&e.desc){var _=iconTools.taskIconFinder(e.schema),u="/wistudio/dist/assets/svg/flogo.flows.detail.diagram.",p=u+"activity.icon.svg";return e.type===constants_1.TASK_TYPE.TASK_ROOT&&(p=u+"trigger.icon.svg"),"<img "+o.ng2StyleAttr+' class="'+exports.CLS.diagramNodeDetailIcon+" "+exports.CLS.diagramDraggablePoint+'" src="'+_+'" alt="" onerror="this.onerror = null; this.src=\''+p+"'\" />\n                <div "+o.ng2StyleAttr+' class="'+exports.CLS.diagramNodeDetailTitle+" "+exports.CLS.diagramDraggablePoint+'" title="'+e.title+'">\n                  <div '+o.ng2StyleAttr+' class="'+exports.CLS.diagramNodeDetailTitleHelper+" "+exports.CLS.diagramDraggablePoint+'">'+e.title+"</div>\n                </div>"}return""})},e.prototype._handleExitNodeDetails=function(e,t){e.exit().remove()},e.prototype._handleNodeDetails=function(e,t){this._handleEnterNodeDetails(e,t),this._handleUpdateNodeDetails(e,t),this._handleExitNodeDetails(e,t)},e.prototype._bindDataToNodeMenus=function(e){return e.data(function(e){return e&&_isNodeHasMenu(e)?[e]:[]})},e.prototype._handleEnterNodeMenus=function(e){e.enter().append("div").attr(this.ng2StyleAttr,"").classed(exports.CLS.diagramDraggablePoint,!0).classed(exports.CLS.diagramNodeMenu,!0).on("click",function(e,t,o){var a=d3.event;if(a.stopPropagation(),a.target.getAttribute(exports.DATA_ATTR.dataMenuItemType)){_triggerCustomEvent("flogoClickNodeMenuItem",{origEvent:d3.event,node:e},this)}})},e.prototype._handleUpdateNodeMenus=function(e){var t=this,o=this;e.html(function(e,a,s){if(e.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT)return"";var n="<li "+o.ng2StyleAttr+' class="'+exports.CLS.diagramNodeMenuList+" "+exports.CLS.diagramDraggablePoint+'" '+exports.DATA_ATTR.dataMenuItemType+'="'+constants_1.FLOW_DIAGRAM_NODE_MENU_ITEM_TYPE.ADD_BRANCH+'" title="Add Branch">\n                                <i '+o.ng2StyleAttr+" "+exports.DATA_ATTR.dataMenuItemType+'="'+constants_1.FLOW_DIAGRAM_NODE_MENU_ITEM_TYPE.ADD_BRANCH+'" class="taskAddBranch '+exports.CLS.diagramDraggablePoint+'"></i>\n                              </li>',r="<li "+o.ng2StyleAttr+' class="'+exports.CLS.diagramNodeMenuList+" "+exports.CLS.diagramDraggablePoint+'" '+exports.DATA_ATTR.dataMenuItemType+'="'+constants_1.FLOW_DIAGRAM_NODE_MENU_ITEM_TYPE.DELETE+'" title="Delete item">\n                                <i '+o.ng2StyleAttr+" "+exports.DATA_ATTR.dataMenuItemType+'="'+constants_1.FLOW_DIAGRAM_NODE_MENU_ITEM_TYPE.DELETE+'" class="taskDeleteButton '+exports.CLS.diagramDraggablePoint+'"></i>\n                              </li>';return e.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH?"<ul "+o.ng2StyleAttr+">"+r+"</ul>":"flow"!==t.diagramType?"<ul "+o.ng2StyleAttr+' class="'+exports.CLS.diagramNodeMenuBox+" "+exports.CLS.diagramDraggablePoint+'">'+r+"</ul>":"<ul "+o.ng2StyleAttr+' class="'+exports.CLS.diagramNodeMenuBox+" "+exports.CLS.diagramDraggablePoint+'">'+n+" "+r+"</ul>"})},e.prototype._handleExitNodeMenus=function(e){e.exit().on("click",null).remove()},e.prototype._handleNodeMenus=function(e){this._handleEnterNodeMenus(e),this._handleUpdateNodeMenus(e),this._handleExitNodeMenus(e)},e.prototype._bindDataToNodeBadges=function(e){var t=this;return e.data(function(e){if(e){var o=t.tasks[e.taskID];if(o)return[{nodeId:e.id,taskId:o.id,errors:t.serviceErrors.tasks[e.taskID]||0}]}return[]})},e.prototype._handleEnterNodeBadges=function(e){e.enter().append("div").attr(this.ng2StyleAttr,"").classed(exports.CLS.diagramDraggablePoint,!0).classed(exports.CLS.diagramNodeBadge,!0)},e.prototype._handleUpdateNodeBadges=function(e){var t=this;e.html(function(e){var o=null,a=exports.CLS.diagramStatusIconHidden;return e&&e.errors&&e.errors>0&&(a=null,o=e.errors>10?"10+":e.errors),"<i "+t.ng2StyleAttr+' class="'+exports.CLS.diagramStatusIcon+" "+exports.CLS.diagramIcError+" "+a+" "+exports.CLS.diagramDraggablePoint+'">'+o+"</i>"})},e.prototype._handleExitNodeBadges=function(e){e.exit().remove()},e.prototype._handleNodeBadges=function(e){this._handleEnterNodeBadges(e),this._handleUpdateNodeBadges(e),this._handleExitNodeBadges(e)},e.prototype.render=function(){constants_2.FLOW_DIAGRAM_DEBUG,this.rootElm=d3.select(this.elm).select("."+exports.CLS.diagram),!this.ng2StyleAttr&&this._updateNG2StyleAttr(),this.nodesOfAddType=this.nodesOfAddType||{};var e=this._bindDataToRows(this.rootElm.selectAll("."+exports.CLS.diagramRow));return this._handleEnterRows(e),this._handleUpdateRows(e),this._handleExitRows(e),constants_2.FLOW_DIAGRAM_DEBUG,Promise.resolve(this)},e.prototype.triggerByTaskID=function(e,t){if(!e||!t)return Promise.resolve(this);var o;for(var a in this.nodes)if(this.nodes[a].taskID===t){o=a;break}if(!this.nodes[o])return Promise.resolve(this);var s,n,r,i=!1;d3.selectAll("."+exports.CLS.diagramNode).each(function(e,t){i?s&&!r&&(r=d3.select(this)):e.id===o?(i=!0,s=d3.select(this)):n=d3.select(this)});try{switch(e){case"addTask":$(r[0][0]).trigger("click");break;case"selectTask":case"selectTrigger":$(s[0][0]).trigger("click");break;default:$(s[0][0]).trigger(e)}}catch(e){constants_2.FLOW_DIAGRAM_DEBUG}return Promise.resolve(this)},e.prototype.linkNodeWithTask=function(e,t){var o=this.nodes[e]||this.nodesOfAddType[e];return o?(o.taskID=t.id,o.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ADD?(this.nodes[o.id]=o,delete this.nodesOfAddType[o.id],o.type=constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE,this.nodes[o.parents[0]].linkToChildren([o.id])):o.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT_NEW&&(o.type=constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ROOT)):constants_2.FLOW_DIAGRAM_DEBUG,Promise.resolve(this)},e.prototype.findNodesByType=function(e,t){var o=[];return t?lodash.each(t,function(t){t.type===e&&o.push(t)}):lodash.mapKeys(this.nodes,function(t){t.type===e&&o.push(t)}),o},e.prototype.findNodesByIDs=function(e){var t=this,o=[];return lodash.each(e,function(e){var a=t.nodes[e];a&&o.push(a)}),o},e.prototype.findChildrenNodesByType=function(e,t){return this.findNodesByType(e,this.findNodesByIDs(t.children))},e.prototype.findParentsNodesByType=function(e,t){return this.findNodesByType(e,this.findNodesByIDs(t.parents))},e.prototype.deleteNode=function(e){var t=this.nodes[e.id];return t?(_deleteNode(t,this.nodes),Promise.resolve(this)):Promise.reject("Node "+e.id+" doesn't exists.")},e.prototype._updateNG2StyleAttr=function(){var e=this,t=this.elm.getElementsByClassName(exports.CLS.diagram),o=/^_ngcontent\-.*$/g;return!(!t||!t.length)&&(Array.prototype.some.call(t[0].attributes,function(t){return!!o.test(t.name)&&(e.ng2StyleAttr=t.name,!0)}),!0)},e}();exports.FlowDiagram=FlowDiagram;