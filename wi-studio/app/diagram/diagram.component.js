"use strict";function checkFamily(e){constants_3.FLOW_DIAGRAM_DEBUG;for(var t in e){for(var n in e[t].parents)lodash.isUndefined(e[e[t].parents[n]])?(constants_3.FLOW_DIAGRAM_DEBUG,removeElement(e[t].parents,e[t].parents[n])):e[e[t].parents[n]].children.includes(t)||e[e[t].parents[n]].children.push(t);for(var a in e[t].children)lodash.isUndefined(e[a])||removeElement(e[t].children,a)}var i=[];for(var r in e){for(var s in e[r].parents)try{e[e[r].parents[s]].children.includes(r)||i.push({id:r,type:"parent"})}catch(t){i.push({id:r,type:"no existe parent: "+e[r].parents[s]})}for(var s in e[r].children)e[e[r].children[s]].parents.includes(r)||i.push({id:r,type:"child not related to this: "+e[r].children[s]})}i.length>0&&constants_3.FLOW_DIAGRAM_DEBUG}function getTraverseChildren(e,t){if(t&&t.id){var n=e.nodes[t.id];if(n&&n.children.length>0){var a=n.children;for(var i in a)a=a.concat(getTraverseChildren(e,e.nodes[a[i]]),getTraverseChildren(e,e.nodesOfAddType[a[i]]));return lodash.uniq(a)}return[]}return[]}function removeElement(e,t){return lodash.remove(e,function(e){return e===t}),e}function isDescendant(e,t){if(!t)return!1;for(var n=t.parentNode;null!==n;){if(n===e)return!0;n=n.parentNode}return!1}function addListener(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}function removeListener(e,t,n){e.addEventListener?e.removeEventListener(t,n,!1):e.detachEvent?e.detachEvent("on"+t,n):e["on"+t]=null}var __decorate=this&&this.__decorate||function(e,t,n,a){var i,r=arguments.length,s=r<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,n):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,a);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(r<3?i(s):r>3?i(t,n,s):i(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),diagram_model_1=require("./models/diagram.model"),constants_1=require("../../common/constants"),constants_2=require("../../common/constants"),constants_3=require("../../common/constants"),node_model_1=require("../../common/models/diagram/node.model"),canvas_service_1=require("../canvas/canvas.service"),lodash=require("lodash"),d3=require("d3"),TCIServices_1=require("../shared/services/TCIServices"),validation_service_1=require("../shared/services/validation/validation.service"),FlowsDetailDiagramComponent=function(){function e(e,t,n,a){var i=this;this.elementRef=e,this._canvasService=t,this.validationService=n,this.tciService=a,this.hasRetry=!1,this._elmRef=e,this.flow=t.getCurrentFlow(),t._msg.on(constants_2.APP_MESSAGING_VALUES.FLOW_CHANGED,function(e){e.type&&(i.type=e.type),i.flow=e.flow?e.flow:i.flow=t.getCurrentFlow(),i._diagram.setDiagramType(i.type),i.initializeDiagram()}),t._msg.on(constants_2.APP_MESSAGING_VALUES.ADD_TASK,function(e){d3.selectAll("["+diagram_model_1.DATA_ATTR.dataTaskId+"='"+e.id+"']").node().click()}),t._msg.on(constants_2.APP_MESSAGING_VALUES.TASK_NAME_UPDATED,function(e){var t=lodash.first(document.querySelectorAll("["+diagram_model_1.DATA_ATTR.dataTaskId+"='"+e.id+"']"));if(t){var n=lodash.first(t.getElementsByClassName(diagram_model_1.CLS.diagramNodeDetailTitleHelper));n.innerHTML=e.title,n.title=e.title,i.tileTitleFix()}}),t._msg.on(constants_2.APP_MESSAGING_VALUES.NODE_ADD,function(e){if(i.flow.paths.nodes[e.nodeId]){var t=document.querySelector("["+diagram_model_1.DATA_ATTR.dataNodeId+'="'+e.nodeId+'"]');if(t.dispatchEvent){var n=t.ownerDocument.createEvent("MouseEvents");n.initEvent("click",!0,!0),t.dispatchEvent(n)}}})}return e.prototype.ngOnInit=function(){var e=this;this.tciService.AppMessaging.on("VALIDATION_ERRORS",function(t){var n=[];t.map(function(e){return e.errors.map(function(e){return n.push(e)})});var a=e.analyseErrors(n).tasks;if(0===Object.keys(a).length)d3.selectAll("."+diagram_model_1.CLS.wistudioTileError+", ."+diagram_model_1.CLS.diagramStatusIcon).classed(diagram_model_1.CLS.wistudioTileError,!1).classed(diagram_model_1.CLS.diagramStatusIconHidden,!0);else{var i=document.getElementsByClassName(diagram_model_1.CLS.diagramNode);for(var r in i)try{var s=i[r].getAttribute(diagram_model_1.DATA_ATTR.dataTaskId);if("-1"!==s){var o=!lodash.isUndefined(a[s]),d=o?a[s]>10?"10+":a[s]:null;d3.select(i[r]).classed(diagram_model_1.CLS.wistudioTileError,o).select("."+diagram_model_1.CLS.diagramStatusIcon).classed(diagram_model_1.CLS.diagramStatusIconHidden,!o).html(d)}}catch(e){}}})},e.prototype.ngAfterViewInit=function(){this.initSub(),this.initializeDiagram(),this.closePaletteOnOutsideClick()},e.prototype.ngOnDestroy=function(){this.closePaletteOnOutsideClick(!0)},e.prototype.ngOnChanges=function(e){var t=this;e.diagram?(constants_3.FLOW_DIAGRAM_DEBUG,constants_3.FLOW_DIAGRAM_DEBUG,constants_3.FLOW_DIAGRAM_DEBUG,this.diagram&&this.tasks&&this._diagram&&this._diagram.updateAndRender({tasks:this.tasks,diagram:this.diagram}).then(function(e){t._diagram=e})):e.tasks&&(constants_3.FLOW_DIAGRAM_DEBUG,constants_3.FLOW_DIAGRAM_DEBUG,constants_3.FLOW_DIAGRAM_DEBUG,this.diagram&&this.tasks&&this._diagram&&this._diagram.updateAndRender({tasks:this.tasks}).then(function(e){t._diagram=e}))},e.prototype.initSub=function(){var e=this;this._canvasService._msg.on(constants_2.APP_MESSAGING_VALUES.ADD_TASK_DONE,function(){return e.initializeDiagram()}),this._canvasService._msg.on(constants_2.APP_MESSAGING_VALUES.UNSELECTED_TASK,function(){return e.unSelectTask()}),this._canvasService._msg.on(constants_2.APP_MESSAGING_VALUES.TASK_DELETED,function(){e._diagram.nodes=e.flow.paths.nodes,e._diagram.render().then(function(){return e._renderDone()})})},e.prototype.initializeDiagram=function(){this.diagram=this.flow.paths,this.tasks=this.flow.items;var e=this.analyseErrors(this.getServiceErrors());try{this._diagram=new diagram_model_1.FlowDiagram(this.diagram,this.tasks,this._elmRef.nativeElement,this.type,e),this._renderDone(),constants_3.FLOW_DIAGRAM_DEBUG}catch(e){this.hasRetry?this._elmRef.nativeElement.parentElement.outerHTML='\n        <div class="panel panel-danger">\n          <div class="panel-heading">\n            <h3 class="panel-title">Current flow contains errors</h3>\n          </div>\n          <div class="panel-body">\n            <h4>Please, contact support</h4>\n            <small>'+JSON.stringify(this.flow)+"</small>\n          </div>\n        </div>\n      ":(this._canvasService.getAppModel().repairRelations(this.flow._id),this.initializeDiagram(),this.hasRetry=!0)}},e.prototype.getServiceErrors=function(){var e=[],t=this.validationService.getAllErrors();return t&&t.length>0&&t.map(function(t){return t.getErrors().map(function(t){return e.push(t)})}),e},e.prototype.analyseErrors=function(e){var t=this,n={tasks:{},nodes:{}};return e.filter(function(e){return e.context}).map(function(e){var a={tasks:"ITEMID",nodes:"NODEID"};for(var i in a){var r=e.context.get(a[i]);r&&(t.flow.items[r]||t.flow.paths.nodes[r])&&(n[i][r]?n[i][r]++:n[i][r]=1)}}),n},e.prototype.addTask=function(e){e.detail.id=this.id,this._canvasService.taskEventHelper=e},e.prototype.selectTask=function(e){this._canvasService.taskEventHelper=e},e.prototype.unSelectTask=function(){this._diagram.exitNodes()},e.prototype.onMenuItemClicked=function(e){var t=e.detail.origEvent.target.getAttribute("data-menu-item-type");lodash.isEmpty(t)||(e.detail.id=this.id)},e.prototype._renderDone=function(){this&&(this.draggable(),this._canvasService.setDiagramFlow(this._diagram),this._canvasService._msg.emit(constants_2.APP_MESSAGING_VALUES.DIAGRAM_FLOW_RENDERED,{}),this.tileTitleFix())},e.prototype.draggable=function(){function e(){y=!1,T={x:0,y:0}}function t(e){if(d3.select(e.target).classed(diagram_model_1.CLS.diagramNode)||d3.select(e.target).classed(diagram_model_1.CLS.diagramDraggablePoint)){u=[];var t=lodash.assign({},l._diagram.nodes,l._diagram.nodesOfAddType);for(var n in t){var i=t[n];for(var d in i.parents)try{var p=t[i.parents[d]];p?p.children.indexOf(i.id)<0&&p.children.push(i.id):delete t[n]}catch(e){return a(),constants_3.FLOW_DIAGRAM_DEBUG,void constants_3.FLOW_DIAGRAM_DEBUG}}l._diagram.nodes=t;for(var g=!1,S=e.target;!g&&S.parentElement;)S.parentElement.classList.contains(diagram_model_1.CLS.diagramNode)?(o=S.parentElement,g=!0):S=S.parentElement;var y=new node_model_1.FlowDiagramNode(d3.select(o).datum());if(h=r(y)){d3.select(o).classed(f,!0);var T=[y.id];for(var n in y.children)l.diagram.nodes[y.children[n]]&&l.diagram.nodes[y.children[n]].type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH&&(T=T.concat(y.children[n]).concat(getTraverseChildren(l._diagram,l.diagram.nodes[y.children[n]])));T.forEach(function(e){var t=d3.select("["+diagram_model_1.DATA_ATTR.dataNodeId+"='"+e+"']").classed(v,!0);l._diagram.nodes[e]&&l._diagram.nodes[e].type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ADD&&t.classed(D,!0)});var L=d3.selectAll("."+diagram_model_1.CLS.diagramNode).filter(function(e){return!lodash.isUndefined(e)&&(e.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ADD||e.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE)}).filter(function(e){return!T.includes(e.id)}).selectAll("."+diagram_model_1.CLS.diagramNodeDetail);lodash.each(L,function(e){var t=e[0],n=d3.select(t).datum().nodeInfo,a=t.parentElement.offsetLeft+t.parentElement.parentElement.offsetLeft,i=t.parentElement.parentElement.offsetTop;"node_add"!==t.parentElement.getAttribute(diagram_model_1.DATA_ATTR.dataFlogoNodeType)&&(i+=t.parentElement.offsetTop);var r=n.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE,s=t.getBoundingClientRect();u.push({object:e.parentNode,flowNode:n,top:i,right:a+s.width,bottom:i+s.height,left:a,isTask:r,hoverClass:r?A:E});document.createElement("div")}),m={top:o.offsetTop+o.parentElement.offsetTop+parseInt(d3.select(o.parentElement).style("margin-top").replace("px",""),10),left:o.offsetLeft},_=lodash.cloneDeep(m),s=d3.select(o.cloneNode(!0)).classed(c,!0),o.parentElement.parentElement.appendChild(s.node()),h=!0}}else h=!1}function n(e){var t=u.filter(function(t){if(e.y>=t.top&&e.y<=t.bottom&&e.x>=t.left&&e.x<=t.right)return!0})[0];return{valid:!!t,info:t}}function a(){if(y&&(e(),h))if(g.valid){l._canvasService.getAppModel();var t=l._diagram.nodes,n=new node_model_1.FlowDiagramNode(d3.select(o).datum()),a=new node_model_1.FlowDiagramNode(g.info.flowNode);t[n.id]=n,constants_3.FLOW_DIAGRAM_DEBUG,constants_3.FLOW_DIAGRAM_DEBUG,constants_3.FLOW_DIAGRAM_DEBUG;var r=new node_model_1.FlowDiagramNode;if(r.parents=lodash.cloneDeep(n.parents),r.children=lodash.cloneDeep(n.children),t[r.id]=r,constants_3.FLOW_DIAGRAM_DEBUG,a.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_ADD){constants_3.FLOW_DIAGRAM_DEBUG;for(var c in r.parents)removeElement(t[r.parents[c]].children,n.id).push(r.id);for(var c in r.children)t[r.children[c]]&&t[r.children[c]].type!==constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH&&removeElement(t[r.children[c]].parents,n.id).push(r.id);if(r.children.includes(a.id)&&removeElement(r.children,a.id).push(n.id),n.parents=lodash.cloneDeep(a.parents),n.children=lodash.cloneDeep(a.children),!n.parents.includes(n.id))for(var c in n.parents)removeElement(t[n.parents[c]].children,a.id).push(n.id);for(var c in n.children)removeElement(t[n.children[c]].parents,a.id).push(n.id);for(var c in t)if(t[c].type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH)for(var _ in t[c].parents.filter(function(e){return e===n.id}))n.children.push(c),removeElement(r.children,c);n.parents.includes(n.id)&&(n.parents=r.parents.includes(a.id)?a.parents:[r.id]),n.children.includes(n.id)&&(removeElement(n.children,n.id).push(r.id),removeElement(r.parents,a.id).push(n.id)),delete t[a.id]}else if(n.children.includes(a.id)){constants_3.FLOW_DIAGRAM_DEBUG;for(var c in r.parents)removeElement(t[r.parents[c]].children,n.id).push(r.id);r.children=[n.id],n.parents=[r.id]}else if(n.parents.includes(a.id)){constants_3.FLOW_DIAGRAM_DEBUG,t[a.id]=a,n.parents=lodash.cloneDeep(a.parents),removeElement(a.children,n.id);for(var c in a.parents)removeElement(t[a.parents[c]].children,a.id).push(n.id);p=[];for(var c in n.children)t[n.children[c]].type!==constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH&&(p.push(n.children[c]),a.children.push(n.children[c]),removeElement(t[n.children[c]].parents,n.id).push(a.id));for(var c in p)removeElement(n.children,p[c]);n.children.push(a.id),a.parents=[n.id],delete t[r.id]}else{constants_3.FLOW_DIAGRAM_DEBUG;for(var c in r.parents)removeElement(t[r.parents[c]].children,n.id).push(r.id);var p=[];for(var c in n.children)t[n.children[c]].type!==constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE_BRANCH?(removeElement(t[n.children[c]].parents,n.id).push(r.id),p.push(n.children[c])):removeElement(r.children,n.children[c]);for(var c in p)removeElement(n.children,p[c]);for(var c in a.parents)removeElement(t[a.parents[c]].children,a.id).push(n.id);n.parents=a.parents,t[a.id].parents=[n.id],n.children.push(a.id)}var f=l._canvasService.getAppModel(),v=f.getFlowById(l.flow._id);v.paths.nodes=t,f.cleanNodes(v._id),checkFamily(t),f.repairRelations(v._id),l._canvasService.saveApp(),l._canvasService._msg.emit(constants_2.APP_MESSAGING_VALUES.ADD_TASK_DONE,{}),i(),constants_3.FLOW_DIAGRAM_DEBUG}else h&&(l._canvasService.getAppModel().cleanNodes(l.flow._id),s.style("transition","all "+d+"ms").style("top",m.top+"px").style("left",m.left+"px"),setTimeout(function(){i()},d))}function i(){s.remove(),d3.selectAll("."+f+",\n        ."+v+",\n        ."+E+",\n        ."+A+",\n        ."+D+",\n        ."+diagram_model_1.CLS.wistudioTileRowHover+",\n        ."+diagram_model_1.CLS.wistudioAddTileDroppable).classed(f,!1).classed(v,!1).classed(E,!1).classed(A,!1).classed(D,!1).classed(diagram_model_1.CLS.wistudioTileRowHover,!1).classed(diagram_model_1.CLS.wistudioAddTileDroppable,!1)}function r(e){return e.type===constants_1.FLOW_DIAGRAM_NODE_TYPE.NODE}if(!(lodash.size(this.flow.items)<2)){var s,o,d,l=this,c="draggedClone",_={top:0,left:0},m={top:0,left:0},p=d3.selectAll("."+diagram_model_1.CLS.diagramNode+"["+diagram_model_1.DATA_ATTR.dataFlogoNodeType+'="node_add"]'),h=!1,f="draggedOriginalElement",v="draggedParent",u=[],g={valid:null,info:null},E="dropableActiveAdd",A="dropableActiveTask",D="noDroppable",S=!1,y=!1,T={x:0,y:0},L=d3.behavior.drag().on("drag",function(e){var a=d3.event;if(T.x+=a.dx,T.y+=a.dy,!y&&(T.x>5||T.x<-5||T.y>5||T.y<-5)&&(y=!0,l._canvasService._msg.emit(constants_2.APP_MESSAGING_VALUES.CLOSE_PALETTE,{}),t(a.sourceEvent)),h&&y){p.classed(diagram_model_1.CLS.wistudioTileRowHover,!0).classed(diagram_model_1.CLS.wistudioAddTileDroppable,!0),_.left+=a.dx,_.top+=a.dy,s.style("top",_.top+"px").style("left",_.left+"px");var i={x:a.x,y:a.y+o.parentElement.offsetTop};(g=n(i)).valid&&!S?(d3.select(g.info.object).classed(g.info.hoverClass,!0),S=!0):!g.valid&&S&&(S=!1)}}).on("dragend",a),O=d3.selectAll("."+diagram_model_1.CLS.diagramNode).attr("isDraggable",!1).filter(function(e){return!lodash.isUndefined(e)&&r(e)}).attr("isDraggable",!0);O.size()>0&&(O.call(L),d=1e3*parseFloat(O.style("transition-duration").replace(/^\D+/g,"")))}},e.prototype.closePaletteOnOutsideClick=function(e){function t(e){if(n._elmRef.nativeElement&&null!==n._elmRef.nativeElement.offsetParent){var t=e.srcElement||e.target,i=!1;try{for(var r in a)if(!i&&(t.classList.contains(a[r])||t.parentElement.classList.contains(a[r]))){i=!0;break}}catch(e){}if(!i)for(var r in a){var s=document.getElementsByClassName(a[r]);for(var o in s)if(!i&&isDescendant(s[o],t)){i=!0;break}}i||n._canvasService._msg.emit(constants_2.APP_MESSAGING_VALUES.CLOSE_PALETTE,{})}}var n=this,a=[diagram_model_1.CLS.diagramNode,"ta-type","error-panel","error-message","fa-angle-left","error-message-content","ui-dialog"];try{if(this.canvas_templ)return;this.canvas_templ=require("../canvas/canvas.component").TEMPL,a.push(this.canvas_templ.CLS.propertyPalettePlacer)}catch(e){return}e?removeListener(document,"click",t):addListener(document,"click",t)},e.prototype.tileTitleFix=function(){var e=this,t=document.getElementsByClassName(diagram_model_1.CLS.diagramNodeDetailTitleHelper);lodash.forEach(t,function(t){e.tileTitleFixElement(t)&&setTimeout(function(){return e.tileTitleFixElement(t)})})},e.prototype.tileTitleFixElement=function(e){return e.classList.add("unfixedHeight"),!(e.clientHeight>22)||(e.classList.remove("unfixedHeight"),!1)},e}();__decorate([core_1.Input(),__metadata("design:type",String)],FlowsDetailDiagramComponent.prototype,"id",void 0),__decorate([core_1.Input(),__metadata("design:type",String)],FlowsDetailDiagramComponent.prototype,"type",void 0),FlowsDetailDiagramComponent=__decorate([core_1.Component({moduleId:module.id,selector:"diagram-handler",template:'<div class="flogo-flows-detail-diagram"\n            (flogoAddTask)="addTask($event)"\n            (flogoSelectTask)="selectTask($event)"\n            (flogoClickNodeMenuItem)="onMenuItemClicked($event)">\n            </div>',styleUrls:["diagram.component.css","diagram.tiles.css"]}),__metadata("design:paramtypes",[core_1.ElementRef,canvas_service_1.CanvasService,validation_service_1.ValidationService,TCIServices_1.TCIServices])],FlowsDetailDiagramComponent),exports.FlowsDetailDiagramComponent=FlowsDetailDiagramComponent;